<!doctype html>
<html lang="vi">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover">
<title>LightUnfold ‚Ä¢ One-Paste UltraMaster</title>
<meta name="description" content="D√°n 1 l·∫ßn l√† ch·∫°y: thanh to√°n ƒëa k√™nh, affiliate t·ªëi ∆∞u CTR, feed VI/EN t·ª± t·∫°o theo th·ªùi ƒëi·ªÉm, si√™u b·ªÅn & an to√†n.">
<meta name="theme-color" content="#0b0f13">
<meta http-equiv="Content-Security-Policy" content="default-src 'self' https: data: blob:; img-src * data: blob:; script-src 'self' https://cdn.jsdelivr.net https://threejs.org 'unsafe-inline'; style-src 'self' 'unsafe-inline'; connect-src *;">
<meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
<meta http-equiv="Pragma" content="no-cache">
<meta http-equiv="Expires" content="0">
<style>
:root{--bg:#0b0f13;--card:#0f141a;--line:#233041;--txt:#e9eef4;--mut:#a9b8c8;--gold:#ffd700;--btn:#ffd700;--btnTxt:#0b0f13;--ring:rgba(255,215,0,.25)}
*{box-sizing:border-box}html,body{height:100%}body{margin:0;background:
radial-gradient(60% 140% at 50% -10%, rgba(109,40,217,.18),transparent 60%),
linear-gradient(180deg, rgba(22,163,74,.10),transparent 40%),var(--bg);
color:var(--txt);font:16px/1.6 system-ui,-apple-system,Segoe UI,Roboto}
.wrap{max-width:1200px;margin:0 auto;padding:18px}
.card{background:var(--card);border:1px solid var(--line);border-radius:18px;padding:16px;margin:12px 0;box-shadow:0 10px 30px rgba(0,0,0,.28)}
.row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
.grid{display:grid;gap:14px;grid-template-columns:repeat(auto-fit,minmax(280px,1fr))}
.pill{display:inline-flex;align-items:center;gap:8px;padding:7px 12px;border:1px solid var(--line);border-radius:999px;background:#101827}
.btn{display:inline-flex;align-items:center;gap:8px;padding:11px 14px;border:0;border-radius:12px;font-weight:800;background:var(--btn);color:var(--btnTxt);cursor:pointer;box-shadow:0 0 0 0 var(--ring);transition:.2s}
.btn:hover{transform:translateY(-1px);box-shadow:0 0 0 6px var(--ring)}
.btn.out{background:transparent;color:var(--txt);border:1px solid var(--line)}
.muted{color:var(--mut)} .mono{font-family:ui-monospace,Menlo,Consolas,monospace}
.badge{display:inline-flex;align-items:center;gap:6px;padding:6px 10px;border:1px solid var(--line);border-radius:999px}
.ok{background:rgba(22,163,74,.15);border-color:#1f3e2b}
.warn{background:rgba(245,158,11,.12);border-color:#3d2e12}
.err{background:rgba(239,68,68,.12);border-color:#3a1212}
.globe3d{width:300px;height:300px;border-radius:50%;display:block;margin:auto}
.qr{width:180px;height:180px;border-radius:12px;background:#fff}
.paybtn{display:flex;justify-content:space-between;align-items:center;border:1px solid var(--line);border-radius:12px;padding:10px 12px;background:transparent;cursor:pointer}
.paybtn.active{outline:2px solid var(--gold);box-shadow:0 0 0 6px rgba(255,215,0,.18)}
.copy{font-size:13px;border:1px dashed var(--line);border-radius:8px;padding:4px 10px;background:transparent;color:var(--txt);cursor:pointer}
.float-share{position:fixed;right:16px;bottom:16px;display:flex;gap:8px;background:var(--card);border:1px solid var(--line);border-radius:14px;padding:10px;z-index:9}
.tag{display:inline-block;border:1px solid var(--line);border-radius:10px;padding:3px 8px;margin:2px 6px 0 0;color:var(--txt);opacity:.85;font-size:12px}
.build{margin-top:12px;text-align:center;color:var(--mut);font-size:13px}
</style>
</head>
<body>
<div class="wrap">
  <div class="row">
    <span class="pill"><b>LightUnfold ‚Ä¢ UltraMaster</b></span>
    <span class="pill">ENS: <b id="ens">lightunfold.eth</b></span>
    <span class="pill">Heartbeat: <b id="hb">‚Äî</b></span>
    <span class="badge ok" id="statusNet">Online</span>
    <span class="badge warn" id="statusFeed">Feed: seed</span>
    <button class="pill" id="lang">VI/EN</button>
  </div>

  <!-- HERO -->
  <section class="card">
    <div class="row" style="justify-content:space-between">
      <div style="min-width:320px;flex:1">
        <h1 style="margin:6px 0 8px" id="hTitle">M·ªôt l·∫ßn d√°n l√† ch·∫°y</h1>
        <div class="muted" id="tagline">Thanh to√°n ƒëa k√™nh ‚Ä¢ Affiliate t·ªëi ∆∞u CTR ‚Ä¢ Feed VI/EN t·ª± t·∫°o theo th·ªùi ƒëi·ªÉm ‚Ä¢ Kh√¥ng spam ‚Ä¢ B·ªÅn b·ªâ</div>
        <div class="row" style="margin-top:12px">
          <a class="btn out" id="ctaB" href="#" target="_blank" rel="noopener">M·ªü Binance Mi·ªÖn Ph√≠ ‚Üó</a>
          <a class="btn out" id="ctaA" href="#" target="_blank" rel="noopener">M·ªü AlgosOne Mi·ªÖn Ph√≠ ‚Üó</a>
        </div>
      </div>
      <div>
        <canvas id="globe3d" class="globe3d"></canvas>
        <div class="muted" style="text-align:center;margin-top:6px" id="globeCap">On-Chain Earth ¬∑ 3D</div>
      </div>
    </div>
  </section>

  <!-- PAY & AFFILIATE -->
  <section class="grid">
    <div class="card">
      <h3 id="hPay">Thanh to√°n nhanh</h3>
      <div id="payList" class="grid" style="grid-template-columns:1fr"></div>
      <div class="row" style="margin-top:10px">
        <div><b id="idLbl">ID/ƒê·ªãa ch·ªâ:</b> <span id="payAddr" class="mono">‚Äî</span></div>
        <button class="btn out" id="btnCopy">Copy</button>
      </div>
      <div class="row" style="margin-top:10px">
        <div class="qr-wrap" style="border:1px dashed var(--line);border-radius:14px;padding:10px"><img id="qr" class="qr" alt="QR"></div>
        <small class="muted" id="payNote">Qu√©t VietQR / v√≠ crypto / PayPal.me. N·ªôi dung chuy·ªÉn: <b>LightUnfold</b>.</small>
      </div>
    </div>
    <div class="card">
      <h3 id="hOffer">∆Øu ƒë√£i n·ªïi b·∫≠t (t·ª± h·ªçc & xoay)</h3>
      <div class="row" id="offerBox"></div>
      <div class="row" style="gap:8px;margin-top:10px">
        <span class="pill" id="tagRegion">Region: ‚Ä¶</span>
        <button class="btn out" data-region="VN">VN</button>
        <button class="btn out" data-region="GLOBAL">Global</button>
        <button class="btn out" data-region="CRYPTO">Crypto</button>
      </div>
      <small class="muted" id="offerNote">Œµ-greedy + UCB (h·ªçc CTR c·ª•c b·ªô, kh√¥ng server).</small>
    </div>
  </section>

  <!-- FEED -->
  <section class="card" id="secFeed">
    <h3 style="margin:0 0 10px" id="hFeed">üî• C∆° h·ªôi / Tin nhanh</h3>
    <div class="muted" id="feedInfo" style="margin-bottom:8px">Hi·ªÉn th·ªã 4‚Äì8 m·ª•c tinh g·ªçn theo th·ªùi ƒëi·ªÉm ng√†y/ƒë√™m. Kh√¥ng nh·ªìi b√†i.</div>
    <div id="feedList" class="grid"></div>
  </section>

  <!-- PREMIUM GATE -->
  <section class="card">
    <h3 id="hGate">SuperGate (m·ªü kho√° n·ªôi dung)</h3>
    <div class="row">
      <label><span id="codeLbl">M√£ m·ªü kho√°:</span> <input id="unlockCode" placeholder="Nh·∫≠p m√£‚Ä¶"></label>
      <button class="btn" id="doUnlock">M·ªü kho√°</button>
      <button class="btn out" id="remember">Nh·ªõ m√£</button>
      <span id="uMsg" class="muted"></span>
    </div>
    <div id="opened" class="muted" style="display:none;margin-top:8px">‚úî ƒê√£ m·ªü kho√° ‚Äì n·ªôi dung Premium hi·ªÉn th·ªã.</div>
  </section>

  <div class="card" id="inlet">
    L·ªëi v√†o: <a href="https://vuhuyphat.github.io/" target="_blank" rel="noopener">Web2</a> ‚Ä¢
    <a href="https://lightunfold.eth.limo/" target="_blank" rel="noopener">ENS</a> ‚Äî Ch·ªâ c·∫ßn file n√†y. N·∫øu c√≥ feed/IPNS sau n√†y, trang t·ª± nh·∫≠n‚Äîkh√¥ng c·∫ßn ƒë·ªïi CID.
    <div class="build" id="buildStamp">Build: ‚Äî</div>
  </div>
</div>

<!-- Floating share -->
<div class="float-share">
  <a id="sh_tg" target="_blank" title="Share Telegram" rel="noopener noreferrer">üì£</a>
  <a id="sh_x"  target="_blank" title="Share X"        rel="noopener noreferrer">ùïè</a>
  <a id="sh_fb" target="_blank" title="Share Facebook" rel="noopener noreferrer">f</a>
  <a id="sh_in" target="_blank" title="Share LinkedIn" rel="noopener noreferrer">in</a>
</div>

<script src="https://cdn.jsdelivr.net/npm/three@0.157.0/build/three.min.js"></script>
<script>
/*** ONE-PASTE ENGINE ***/
const CFG = {
  ens:'lightunfold.eth',
  links:{
    binance:'https://www.binance.com/referral/earn-together/refer-in-hotsummer/claim?hl=vi&ref=GRO_20338_9V44N',
    algos:'https://algosone.page.link/MbtR'
  },
  payments:{
    eth:{label:'ETH (ENS)',id:'lightunfold.eth',scheme:'ethereum:'},
    usdt:{label:'USDT (ERC-20)',id:'0x5da80d0f7e2df3cb0aa73d6a942bbe36b046b8f0'},
    momo:{label:'MoMo',id:'0567892030'},
    bank:{label:'Vietcombank',id:'9567892030|TR·∫¶N VƒÇN V≈®'},
    paypal:{label:'PayPal',id:'vumumabada@gmail.com'}
  },
  premium:{unlock_code:'23061988'},
  ipns_id:'', // n·∫øu sau n√†y c√≥, d√°n k51... v√†o ƒë√¢y (trang v·∫´n ch·∫°y n·∫øu ƒë·ªÉ tr·ªëng)
  repo_raw:'https://raw.githubusercontent.com/vuhuyphat/vuhuyphat.github.io/main'
};
const $=s=>document.querySelector(s), $$=s=>document.querySelectorAll(s);
const LS_STATS='onepaste_stats_v3';
function isVN(){ const l=(navigator.language||'').toLowerCase(); const tz=Intl.DateTimeFormat().resolvedOptions().timeZone||''; return l.startsWith('vi')||tz.includes('Bangkok')||tz.includes('Ho_Chi_Minh'); }
let LANG=(localStorage.getItem('lang')||(isVN()?'vi':'en'));
function setLang(l){ LANG=l; localStorage.setItem('lang',l); applyLang(); renderOffers(); renderFeed(lastFeed, lastSource); }

/*** 1) I18N ***/
function applyLang(){
  const vi=LANG==='vi';
  $('#hTitle').textContent = vi?'M·ªôt l·∫ßn d√°n l√† ch·∫°y':'One-paste and go';
  $('#tagline').textContent= vi?'Thanh to√°n ƒëa k√™nh ‚Ä¢ Affiliate t·ªëi ∆∞u CTR ‚Ä¢ Feed VI/EN t·ª± t·∫°o theo th·ªùi ƒëi·ªÉm ‚Ä¢ Kh√¥ng spam ‚Ä¢ B·ªÅn b·ªâ':
                               'Multi-channel payments ‚Ä¢ CTR-optimized affiliate ‚Ä¢ Time-aware VI/EN feed ‚Ä¢ No spam ‚Ä¢ Resilient';
  $('#hPay').textContent   = vi?'Thanh to√°n nhanh':'Payments';
  $('#idLbl').textContent  = vi?'ID/ƒê·ªãa ch·ªâ:':'ID/Address:';
  $('#payNote').innerHTML  = vi?'Qu√©t VietQR / v√≠ crypto / PayPal.me. N·ªôi dung chuy·ªÉn: <b>LightUnfold</b>.':
                               'Scan VietQR / crypto wallet / PayPal.me. Note: <b>LightUnfold</b>.';
  $('#hOffer').textContent = vi?'∆Øu ƒë√£i n·ªïi b·∫≠t (t·ª± h·ªçc & xoay)':'Featured offers (learn & rotate)';
  $('#offerNote').textContent = vi?'Œµ-greedy + UCB (h·ªçc CTR c·ª•c b·ªô, kh√¥ng server).':'Œµ-greedy + UCB (local CTR learning, no server).';
  $('#hFeed').textContent  = vi?'üî• C∆° h·ªôi / Tin nhanh':'üî• Opportunities / Quick briefs';
  $('#hGate').textContent  = vi?'SuperGate (m·ªü kho√° n·ªôi dung)':'SuperGate (unlock content)';
  $('#codeLbl').textContent= vi?'M√£ m·ªü kho√°:':'Unlock code:';
  $('#globeCap').textContent=vi?'Tr√°i ƒê·∫•t On-Chain ¬∑ 3D':'On-Chain Earth ¬∑ 3D';
  $('#lang').textContent   = vi?'VI/EN':'EN/VI';
}
applyLang(); $('#lang').onclick=()=>setLang(LANG==='vi'?'en':'vi');
setInterval(()=>{ $('#hb').textContent=new Date().toLocaleTimeString(); },1000);
$('#ens').textContent=CFG.ens;
(function share(){ const base=location.origin+location.pathname; const peer=localStorage.getItem('peer_id')||Math.random().toString(36).slice(2); localStorage.setItem('peer_id',peer);
  const myRef=`${base}?ref=${peer}`, t=encodeURIComponent(document.title), u=encodeURIComponent(myRef);
  const map={sh_tg:`https://t.me/share/url?url=${u}&text=${t}`,sh_x:`https://twitter.com/intent/tweet?text=${t}&url=${u}`,sh_fb:`https://www.facebook.com/sharer/sharer.php?u=${u}`,sh_in:`https://www.linkedin.com/sharing/share-offsite/?url=${u}`};
  for(const id in map){ const el=document.getElementById(id); if(el) el.href=map[id]; }
})();

/*** 2) Net badges & build stamp ***/
function netBadge(ok){ const el=$('#statusNet'); el.textContent=ok?'Online':'Offline'; el.className='badge '+(ok?'ok':'err'); }
window.addEventListener('online',()=>netBadge(true)); window.addEventListener('offline',()=>netBadge(false)); netBadge(navigator.onLine);
document.getElementById('buildStamp').textContent = 'Build: ' + new Date().toLocaleString();

/*** 3) Payments ***/
function setQR(text){ $('#qr').src=`https://api.qrserver.com/v1/create-qr-code/?size=340x340&data=${encodeURIComponent(text)}`; }
function copy(txt){ return navigator.clipboard.writeText(txt).then(()=>alert(LANG==='vi'?'ƒê√£ sao ch√©p.':'Copied.')).catch(()=>alert(LANG==='vi'?'Thi·∫øt b·ªã ch·∫∑n clipboard.':'Clipboard blocked.')); }
function paintPayments(){
  const pays=CFG.payments, list=$('#payList'); list.innerHTML=''; const rows=[];
  const map={
    eth:v=>({title:'ETH (ENS/Address)',id:v.id,qr:(v.scheme||'ethereum:')+v.id}),
    usdt:v=>({title:'USDT (ERC-20)',id:v.id,qr:v.id}),
    momo:v=>({title:'MoMo',id:v.id,qr:v.id}),
    bank:v=>{const [acc,name]=(v.id||'').split('|');return {title:'Vietcombank',id:`${acc} ‚Ä¢ ${name||''}`,qr:`VCB:${acc}?memo=LightUnfold&name=${encodeURIComponent(name||'')}`}},
    paypal:v=>({title:'PayPal',id:v.id,qr:`paypal.me/${encodeURIComponent((v.id||'').split('@')[0])}`})
  };
  Object.entries(map).forEach(([k,fn])=>{
    if(!pays[k]) return; const norm=fn(pays[k]);
    const row=document.createElement('div'); row.className='paybtn';
    row.innerHTML=`<div><b>${norm.title}</b><div class="muted mono">${norm.id}</div></div><button class="copy">Copy</button>`;
    row.onclick=()=>{ $('#payAddr').textContent=norm.id; setQR(norm.qr); $$('.paybtn').forEach(x=>x.classList.remove('active')); row.classList.add('active'); };
    row.querySelector('.copy').onclick=(e)=>{ e.stopPropagation(); copy(norm.id); };
    list.appendChild(row); rows.push(row);
  });
  if(rows[0]) rows[0].click(); $('#btnCopy').onclick=()=>copy($('#payAddr').textContent||'');
}

/*** 4) Offers ‚Äì bandit (CTR local) ***/
function region(){ const v=localStorage.getItem('ab_region'); if(v) return v; return isVN()?'VN':'GLOBAL'; }
function stats(){ try{return JSON.parse(localStorage.getItem('onepaste_stats_v3')||'{}')}catch{return{}} }
function saveStats(s){ localStorage.setItem('onepaste_stats_v3', JSON.stringify(s)); }
function banditPick(pool){ const s=stats(); s.stats=s.stats||{}; s.total=s.total||0; if(Math.random()<0.12) return pool[Math.floor(Math.random()*pool.length)];
  let best=pool[0],score=-1; for(const o of pool){ const st=s.stats[o.id]||{}; const ctr=(st.c||0)/Math.max(1,(st.v||0));
    const ucb=ctr+Math.sqrt(2*Math.log(1+(s.total||1))/Math.max(1,(st.v||0))); if(ucb>score){score=ucb;best=o;} } return best; }
function markView(id){ const s=stats(); s.stats=s.stats||{}; s.stats[id]=s.stats[id]||{v:0,c:0}; s.stats[id].v++; s.total=(s.total||0)+1; saveStats(s); }
function markClick(id){ const s=stats(); s.stats=s.stats||{}; s.stats[id]=s.stats[id]||{v:0,c:0}; s.stats[id].c++; saveStats(s); }
function renderOffers(){
  const r=region(); $('#tagRegion').textContent='Region: '+r;
  const OFFERS=[
    {id:'binance',title:LANG==='vi'?'M·ªü Binance Mi·ªÖn Ph√≠':'Open Binance Free',url:CFG.links.binance,regions:['VN','GLOBAL']},
    {id:'algos',title:LANG==='vi'?'M·ªü AlgosOne Mi·ªÖn Ph√≠':'Open AlgosOne Free',url:CFG.links.algos,regions:['GLOBAL','CRYPTO','VN']}
  ];
  const pool=OFFERS.filter(o=>o.regions.includes(r)); const pick=banditPick(pool.length?pool:OFFERS);
  const box=$('#offerBox');
  box.innerHTML=`<a class="btn out" id="offer" href="${pick.url}" target="_blank" rel="noopener">üî• ${pick.title}</a>
                 <a class="btn out" href="${CFG.links.binance}" target="_blank" rel="noopener">üöÄ Binance</a>
                 <a class="btn out" href="${CFG.links.algos}"   target="_blank" rel="noopener">üåê AlgosOne</a>`;
  $('#offer').addEventListener('click',()=>markClick(pick.id)); markView(pick.id);
  $('#ctaB').href=CFG.links.binance; $('#ctaA').href=CFG.links.algos;
}
$$('button[data-region]').forEach(b=>b.onclick=()=>{ localStorage.setItem('ab_region', b.dataset.region); location.reload(); });

/*** 5) FEED ***/
function sanitize(html){
  try{
    const tmp=document.createElement('div'); tmp.innerHTML=html||'';
    const OK=new Set(['B','I','EM','STRONG','P','BR','UL','OL','LI','A','CODE','PRE','SPAN','SMALL']);
    (function walk(n){ [...n.children].forEach(ch=>{
      if(!OK.has(ch.tagName)){ ch.replaceWith(document.createTextNode(ch.textContent||'')); return; }
      [...ch.attributes].forEach(a=>{ if(!(ch.tagName==='A' && ['href','target','rel'].includes(a.name.toLowerCase()))) ch.removeAttribute(a.name); });
      if(ch.tagName==='A'){ try{ const u=new URL(ch.getAttribute('href'),location.href); if(!/^https?:/i.test(u.protocol)) ch.removeAttribute('href'); }catch(_){ ch.removeAttribute('href'); }
        ch.setAttribute('rel','noopener noreferrer'); ch.setAttribute('target','_blank'); }
      walk(ch);
    }); })(tmp);
    return tmp.innerHTML;
  }catch(_){ return ''; }
}
function timeSlot(){
  const h=new Date().getHours();
  if(h<11) return {vi:['S√°ng','Layer2','Theo d√µi c·∫ßu n·ªëi & volume tƒÉng.'], en:['Morning','Layer2','Bridge flow & rising volume.']};
  if(h<17) return {vi:['Tr∆∞a','Funding','Quan s√°t funding & ƒë·ªô l·ªách.'],      en:['Midday','Funding','Watch funding & skew.']};
  return           {vi:['T·ªëi','Stable Flows','Theo d√µi netflow CEX/DEX.'],    en:['Evening','Stable Flows','Track CEX/DEX netflow.']};
}
function seedFeed(lang){
  const slot=timeSlot()[lang];
  const items=[
    {t:`${slot[0]} ‚Ä¢ ${slot[1]} ‚Ä¢ Binance`, url:CFG.links.binance, body:lang==='vi'?'∆Øu ƒë√£i ng∆∞·ªùi m·ªõi, ph√≠ c·∫°nh tranh.':'New user perks, competitive fees.', tags:[slot[1].toLowerCase(),'onboarding','cex']},
    {t:`${slot[0]} ‚Ä¢ ${slot[1]} ‚Ä¢ AlgosOne`, url:CFG.links.algos, body:lang==='vi'?'C·∫£nh b√°o realtime, k·ªãch b·∫£n 2 chi·ªÅu.':'Realtime alerts, two-sided plays.', tags:[slot[1].toLowerCase(),'ai','signals']}
  ];
  return {
    updated_at:new Date().toISOString(),
    items:items.map(x=>({id:x.t.toLowerCase().replace(/[^a-z0-9]+/g,'-')+'-'+Date.now(), title:x.t,
      body_html:`<p>${x.body}</p>`, cta:{label: x.t.includes('Binance')?(lang==='vi'?'M·ªü Binance':'Open Binance'):(lang==='vi'?'M·ªü AlgosOne':'Open AlgosOne'), url:x.url}, tags:x.tags, lang}))
  };
}
let lastFeed=null, lastSource='seed';
function renderFeed(feed, source){
  lastFeed=feed; lastSource=source;
  $('#statusFeed').textContent='Feed: '+(source); $('#statusFeed').className='badge '+(source==='remote'?'ok':(source==='cache'?'warn':'warn'));
  $('#feedInfo').textContent=(LANG==='vi'?'C·∫≠p nh·∫≠t: ':'Updated: ')+new Date(feed.updated_at).toLocaleString()+' ‚Ä¢ '+source;
  const box=$('#feedList'); box.innerHTML='';
  const seen=new Set(); const list=(feed.items||[]).filter(x=>x&&x.id&&!seen.has(x.id)&&(seen.add(x.id),true)).slice(0,8);
  list.forEach(it=>{
    const card=document.createElement('div'); card.className='card';
    const body=sanitize(it.body_html||''); const tags=(it.tags||[]).map(t=>`<span class="tag">#${t}</span>`).join(' ');
    card.innerHTML=`<b>${it.title||''}</b><div class="muted" style="margin:6px 0">${tags}</div><div>${body}</div>
    ${it.cta?.url?`<div class="row" style="margin-top:8px"><a class="btn out" href="${it.cta.url}" target="_blank" rel="noopener">${it.cta.label|| (LANG==='vi'?'Xem':'Open')}</a></div>`:''}`;
    box.appendChild(card);
  });
}
async function tryFetch(url){ try{ const r=await fetch(url,{cache:'no-store'}); if(!r.ok) throw 0; return await r.json(); }catch(_){ return null; } }
async function loadExternalFeed(){
  const files = LANG==='en' ? ['feed.en.json'] : ['feed.vi.json'];
  const urls=[];
  if(CFG.repo_raw) urls.push(`${CFG.repo_raw}/${files[0]}`);
  if(CFG.ipns_id){ urls.push(`https://ipfs.io/ipns/${CFG.ipns_id}/${files[0]}`); urls.push(`https://cloudflare-ipfs.com/ipns/${CFG.ipns_id}/${files[0]}`); }
  for(const u of urls){ const d=await tryFetch(u); if(d&&d.items?.length){ return {data:d, source:'remote'}; }
  }
  return null;
}

/*** 6) Gate ***/
function bindGate(){
  const SECRET=String(CFG.premium?.unlock_code||'');
  $('#doUnlock').onclick=()=>{ const ok=(String($('#unlockCode').value||'').trim()===SECRET);
    $('#uMsg').textContent= ok ? (LANG==='vi'?'‚úÖ ƒê√£ m·ªü kho√°':'‚úÖ Unlocked') : (LANG==='vi'?'‚ùå Sai m√£':'‚ùå Wrong code');
    $('#opened').style.display = ok ? 'block':'none';
    if(ok) localStorage.setItem('premium_unlocked','1');
  };
  $('#remember').onclick=()=> localStorage.setItem('remember_code',$('#unlockCode').value||'');
  if(localStorage.getItem('premium_unlocked')==='1') $('#opened').style.display='block';
}

/*** 7) 3D Earth ***/
(function earth(){
  try{
    const canvas=document.getElementById('globe3d'); const pref=window.matchMedia('(prefers-reduced-motion: reduce)').matches;
    const renderer=new THREE.WebGLRenderer({canvas,antialias:true,alpha:true});
    const DPR=Math.min(window.devicePixelRatio||1,2); const W=canvas.clientWidth||300,H=canvas.clientHeight||300;
    renderer.setPixelRatio(DPR); renderer.setSize(W,H,false);
    const scene=new THREE.Scene(); const camera=new THREE.PerspectiveCamera(50,W/H,0.1,100); camera.position.z=6;
    scene.add(new THREE.AmbientLight(0x9fc9ff,0.55), new THREE.DirectionalLight(0xffffff,0.95));
    const loader=new THREE.TextureLoader();
    const earth=new THREE.Mesh(new THREE.SphereGeometry(2.4,64,64),
      new THREE.MeshPhongMaterial({map:loader.load('https://threejs.org/examples/textures/planets/earth_atmos_2048.jpg')}));
    scene.add(earth);
    (function anim(){ if(!pref) earth.rotation.y+=0.0024; renderer.render(scene,camera); requestAnimationFrame(anim); })();
  }catch(e){ $('#globeCap').textContent='‚Äî'; }
})();

/*** 8) Boot ***/
(function start(){
  $('#statusNet').textContent = navigator.onLine ? 'Online' : 'Offline';
  $('#statusNet').className   = 'badge ' + (navigator.onLine ? 'ok' : 'err');

  paintPayments(); renderOffers();

  (async ()=>{
    const ext = await loadExternalFeed();
    if(ext){ renderFeed(ext.data, ext.source); }
    else   { renderFeed(seedFeed(LANG), 'seed'); }
  })();

  bindGate();
})();
</script>

<!-- Service Worker (cache g·ªçn, v·∫´n t√¥n tr·ªçng no-store khi fetch feed) -->
<script>
if('serviceWorker' in navigator){
  const sw = `
    const CACHE='onepaste-v3';
    self.addEventListener('install',e=>{e.waitUntil(caches.open(CACHE).then(c=>c.addAll(['./'])) )});
    self.addEventListener('fetch',e=>{
      e.respondWith(
        caches.match(e.request).then(r=>r||fetch(e.request).then(res=>{
          const copy=res.clone(); caches.open(CACHE).then(c=>c.put(e.request,copy)); return res;
        }).catch(()=>r))
      );
    });
  `;
  const blob = new Blob([sw],{type:'text/javascript'}); const url = URL.createObjectURL(blob);
  navigator.serviceWorker.register(url).catch(()=>{});
}
</script>
</body>
</html>
