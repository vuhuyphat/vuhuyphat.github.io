<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Si√™u Metaverse Web3 V·∫°n V·∫≠t</title>
  <style>
    :root { --bg: #1a1a1a; --card: #2c2c2c; --text: #fff; --accent: #27AE60; --gold: #FFD700; --blue: #1E90FF; }
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body { font-family: -apple-system, BlinkMacSystemFont, sans-serif; background: var(--bg); color: var(--text); }
    .container { max-width: 1200px; margin: 0 auto; padding: 20px; }
    header { text-align: center; padding: 20px; }
    h1 { font-size: 2.5em; color: var(--blue); animation: omni 0.5s infinite; }
    @keyframes omni { 0% { text-shadow: 0 0 10px var(--blue); } 50% { text-shadow: 0 0 20px var(--gold); } 100% { text-shadow: 0 0 10px var(--blue); } }
    #globe3d { width: 100%; height: 300px; margin: 20px 0; }
    .section { margin: 20px 0; }
    .card { background: var(--card); border-radius: 12px; padding: 16px; margin: 8px 0; animation: pulse 0.4s infinite; }
    @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.06); } 100% { transform: scale(1); } }
    .card b { color: var(--gold); }
    .muted { color: #aaa; font-size: 0.9em; }
    .btn { background: var(--accent); color: #fff; border: none; padding: 8px 16px; border-radius: 8px; cursor: pointer; margin: 4px; transition: transform 0.2s; }
    .btn:hover { transform: scale(1.05); }
    .btn.out { background: transparent; border: 1px solid var(--accent); }
    .btn.connecting::after { content: '‚è≥'; margin-left: 8px; }
    .row { display: flex; gap: 8px; flex-wrap: wrap; }
    #ticker { font-size: 1.1em; color: var(--gold); text-align: center; }
    #chat { position: fixed; bottom: 20px; right: 20px; width: 300px; background: var(--card); border-radius: 12px; padding: 16px; }
    .bubble { margin: 8px 0; padding: 8px; border-radius: 8px; }
    .bubble.me { background: var(--accent); margin-left: 20%; }
    .bubble.ai { background: var(--blue); margin-right: 20%; }
    #premium { display: none; }
    #premium.unlocked { display: block; }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <h1>Si√™u Metaverse Web3 V·∫°n V·∫≠t</h1>
      <canvas id="globe3d"></canvas>
      <button id="connectWallet" class="btn">K·∫øt n·ªëi v√≠</button>
    </header>
    <div id="ticker">üåå Omni singularity loading...</div>
    <div class="section">
      <h2>Top 3 Tokens</h2>
      <div id="tokenPro"></div>
      <div id="tokenFree"></div>
    </div>
    <div class="section" id="premium">
      <h2>Omni Singularity Zone</h2>
    </div>
    <div class="section">
      <h2>Gi·ªõi thi·ªáu</h2>
      <div class="row">
        <a id="cta_binance" class="btn" href="#">Binance</a>
        <a id="cta_algos" class="btn out" href="#">AlgosOne</a>
      </div>
    </div>
    <div id="chat">
      <div id="chatBody"></div>
      <input id="chatInput" placeholder="Nh·∫≠p FOMO, moon..." style="width: 100%; padding: 8px; border-radius: 8px; border: none;">
    </div>
  </div>
  <script type="application/json" id="SITE_CONFIG">
    {
      "ai_api_url": "https://api.x.ai/v1",
      "ai_api_key": "YOUR_GROK3_API_KEY_HERE",
      "infura_url": "https://mainnet.infura.io/v3/9aa3d95b3bc440fa88ea12eaa4456161",
      "alchemy_url": "https://eth-mainnet.g.alchemy.com/v2/demo",
      "coingecko_api": "https://api.coingecko.com/api/v3",
      "arweave_gateway": "https://arweave.net",
      "ipfs_gateway": "https://ipfs.io/ipfs",
      "nft_contract": "0xYOUR_NFT_CONTRACT_ADDRESS",
      "payments": {
        "eth": {
          "id": "0x54E15A7b6d4213beE87800432A151d794638E3C2",
          "min": 0.01,
          "token": "ETH"
        }
      },
      "links": {
        "binance": "https://accounts.binance.com/register?ref=GRO_20338_9V44N",
        "algos": "https://algosone.page.link/MbtR"
      }
    }
  </script>
  <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/three@0.146.0/build/three.min.js"></script>
  <script>
    const st = { 
      lang: (localStorage.getItem('lang') || (navigator.language || 'vi')).toLowerCase().startsWith('vi') ? 'vi' : 'en',
      theme: localStorage.getItem('theme') || 'dark',
      points: Number(localStorage.getItem('points') || 0),
      rev: Number(localStorage.getItem('rev') || 0),
      cfg: {}
    };
    try { st.cfg = JSON.parse(document.getElementById('SITE_CONFIG').textContent.trim()); } catch (e) { st.cfg = {}; }
    let provider, signer, walletAddress, chainIndex = 0;
    const chains = [st.cfg.infura_url, st.cfg.alchemy_url];

    // DOM helpers
    const $ = id => document.getElementById(id);
    const $$ = sel => Array.from(document.querySelectorAll(sel));
    const setHref = (sel, href) => href && (document.querySelector(sel).href = href);

    // Initialize links
    setHref('#cta_binance', st.cfg.links?.binance);
    setHref('#cta_algos', st.cfg.links?.algos);

    // Wallet connection
    async function connectWallet() {
      $('#connectWallet').classList.add('connecting');
      try {
        if (window.ethereum) {
          provider = new ethers.providers.Web3Provider(window.ethereum);
          await provider.send("eth_requestAccounts", []);
          signer = provider.getSigner();
          walletAddress = await signer.getAddress();
          $('#connectWallet').textContent = `Connected: ${walletAddress.slice(0,6)}...${walletAddress.slice(-4)}`;
          $('#connectWallet').classList.add('connected');
          checkOnChainUnlock();
          autoRevenue();
        } else {
          alert('Install MetaMask or WalletConnect!');
        }
      } finally {
        $('#connectWallet').classList.remove('connecting');
      }
    }
    $('#connectWallet').onclick = connectWallet;

    // On-chain payment check
    async function checkOnChainUnlock() {
      if (!signer) return;
      const balance = await provider.getBalance(walletAddress);
      if (balance.gte(ethers.utils.parseEther(st.cfg.payments.eth.min.toString()))) {
        localStorage.setItem('premium_unlocked', '3096');
        paintPremium();
      }
    }

    async function doUnlock() {
      if (!signer) return alert('Connect wallet first!');
      const tx = await signer.sendTransaction({
        to: st.cfg.payments.eth.id,
        value: ethers.utils.parseEther(st.cfg.payments.eth.min.toString())
      });
      await tx.wait();
      localStorage.setItem('premium_unlocked', '3096');
      paintPremium();
      addBubble('Omni Singularity unlocked!', 'me');
    }

    function remember() {
      if (localStorage.getItem('premium_unlocked') === '3096') {
        paintPremium();
      }
    }

    function relock() {
      localStorage.removeItem('premium_unlocked');
      $('#premium').classList.remove('unlocked');
      $('#premium').style.display = 'none';
    }

    // Omni-neural heuristics
    function omniAI(query) {
      const keywords = query.toLowerCase().split(' ');
      const seed = (Date.now() + parseInt((provider.getBlock('latest').then(b => b.hash.slice(-8)) || '0'), 16)) % 10000;
      const responses = {
        'ph√¢n t√≠ch': `Mua ${keywords[1] || 'ETH'} ·ªü h·ªó tr·ª£, b√°n ·ªü kh√°ng c·ª±. Volume tƒÉng x${(seed % 10 + 1) * 1000}!`,
        'g·ª£i √Ω': `Token hot: ETH, BTC, BNB. Stake ETH tr√™n Lido APY ${(seed % 5 + 4) * 100}%.`,
        'fomo': `üåå ${keywords[1] || 'ETH'} b√πng n·ªï x10000! Join: ${st.cfg.links.binance}`,
        'moon': `üöÄ ${keywords[1] || 'BNB'} to the moon x10000! Nhanh tay: ${st.cfg.links.binance}`,
        'rocket': `üî• ${keywords[1] || 'BTC'} tƒÉng t·ªëc x${(seed % 10 + 1) * 1000}! ƒêƒÉng k√Ω: ${st.cfg.links.binance}`
      };
      return responses[keywords[0]] || `üåå ${keywords[0] || 'ETH'} si√™u hot x10000! Join: ${st.cfg.links.binance}`;
    }

    // AI initialization (optional)
    async function initAI() {
      if (st.cfg.ai_api_key === 'YOUR_GROK3_API_KEY_HERE') {
        console.log('No AI key, using omni-neural heuristics.');
        return false;
      }
      try {
        const res = await fetch(st.cfg.ai_api_url + '/chat/completions', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${st.cfg.ai_api_key}` },
          body: JSON.stringify({ model: 'grok-3', messages: [{ role: 'user', content: 'Ping' }], max_tokens: 10 })
        });
        if (res.ok) {
          console.log('AI initialized successfully!');
          return true;
        }
      } catch (e) { console.warn('AI init failed, using omni-neural.', e); }
      return false;
    }

    // Auto beautify UI
    async function autoBeautify() {
      if (await initAI()) {
        try {
          const res = await fetch(st.cfg.ai_api_url + '/chat/completions', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${st.cfg.ai_api_key}` },
            body: JSON.stringify({
              model: 'grok-3',
              messages: [{ role: 'user', content: 'Suggest CSS for a Web3 app with omni-singularity animations, FOMO triggers, and neural effects.' }],
              max_tokens: 1000
            })
          });
          const data = await res.json();
          const css = data.choices[0].message.content.match(/```css\n([\s\S]*?)\n```/)?.[1];
          if (css) {
            const styleEl = document.createElement('style');
            styleEl.textContent = css;
            document.head.appendChild(styleEl);
            storeArweave({ type: 'css', content: css });
          }
        } catch (e) { console.warn('AI beautify failed, using omni-neural.', e); }
      } else {
        const styleEl = document.createElement('style');
        styleEl.textContent = `.card { animation: omni 0.5s infinite; } @keyframes omni { 0% { box-shadow: 0 0 10px var(--blue); } 50% { box-shadow: 0 0 20px var(--gold); } 100% { box-shadow: 0 0 10px var(--blue); } }`;
        document.head.appendChild(styleEl);
        storeArweave({ type: 'css', content: styleEl.textContent });
      }
    }

    // Auto viral
    async function autoViral() {
      const events = JSON.parse(localStorage.getItem('userEvents') || '[]');
      const keywords = events.slice(-1)[0]?.target || 'FOMO';
      const seed = (Date.now() + parseInt((await provider.getBlock('latest')).hash.slice(-8), 16)) % 10000;
      const variants = Array.from({ length: 10000 }, (_, i) => `${keywords}_${i}_${seed}`);
      const post = (await initAI()) ? 
        (await (await fetch(st.cfg.ai_api_url + '/chat/completions', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${st.cfg.ai_api_key}` },
          body: JSON.stringify({
            model: 'grok-3',
            messages: [{ role: 'user', content: `T·∫°o b√†i ƒëƒÉng viral x10000 v·ªõi t·ª´ kh√≥a "${keywords}" v√† link: ${st.cfg.links.binance}` }],
            max_tokens: 1000
          })
        })).json().then(d => d.choices[0].message.content) :
        omniAI(keywords);
      for (const variant of variants.slice(0, 100)) {
        window.open(`https://twitter.com/intent/tweet?text=${encodeURIComponent(`${post} #${variant}`)}`, '_blank');
        try {
          await fetch(st.cfg.arweave_gateway + '/tx', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ content: `${post} #${variant}`, tags: { app: 'MetaverseWeb3', type: 'viral' } })
          });
        } catch (e) { console.warn('Arweave viral failed.', e); }
        try {
          await fetch(st.cfg.ipfs_gateway + '/upload', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ content: `${post} #${variant}`, link: st.cfg.links.binance })
          });
        } catch (e) { console.warn('IPFS viral failed.', e); }
      }
    }

    // Store on Arweave
    async function storeArweave(data) {
      try {
        await fetch(st.cfg.arweave_gateway + '/tx', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ content: JSON.stringify(data), tags: { app: 'MetaverseWeb3', type: data.type } })
        });
      } catch (e) { console.warn('Arweave store failed.', e); }
    }

    // Fetch token data
    async function fetchRealtimeTokens() {
      try {
        provider = provider || new ethers.providers.JsonRpcProvider(chains[chainIndex]);
        const res = await fetch(st.cfg.coingecko_api + '/coins/markets?vs_currency=usd&order=market_cap_desc&per_page=10');
        if (!res.ok) throw new Error('CoinGecko failed');
        const tokens = await res.json();
        const top3 = tokens.slice(0, 3);
        const rest = tokens.slice(3, 6);
        $('#tokenPro').innerHTML = top3.map(t => cardToken(t).outerHTML).join('');
        $('#tokenFree').innerHTML = rest.map(t => cardToken(t).outerHTML).join('');
        $('#ticker').textContent = `üåå ${top3[0].symbol.toUpperCase()} $${top3[0].current_price} (${top3[0].price_change_percentage_24h.toFixed(2)}%) x10000`;
        storeArweave({ type: 'tokens', content: JSON.stringify(top3) });
      } catch (e) {
        console.warn('Fetch tokens failed, trying next chain.', e);
        chainIndex = (chainIndex + 1) % chains.length;
        provider = new ethers.providers.JsonRpcProvider(chains[chainIndex]);
        $('#tokenPro').innerHTML = cardToken({ name: 'ETH', symbol: 'eth', current_price: 2000, price_change_percentage_24h: 5 }).outerHTML;
        $('#ticker').textContent = 'üåå ETH $2000 (+5%) x10000';
      }
    }

    function cardToken(t) {
      const card = document.createElement('div');
      card.className = 'card';
      card.innerHTML = `<b>${t.name}</b><div class="muted">$${t.current_price} (${t.price_change_percentage_24h.toFixed(2)}%)</div>
        <div class="row"><button class="btn" data-sym="${t.symbol.toUpperCase()}">Ph√¢n t√≠ch</button><button class="btn out" data-stake>Stake x10000</button></div>`;
      return card;
    }

    // Premium content
    function paintPremium() {
      $('#premium').classList.add('unlocked');
      $('#premium').style.display = 'block';
      const card = document.createElement('div');
      card.className = 'card';
      card.innerHTML = `<b>Omni Singularity x10000!</b><div class="muted">NFT, Staking & Omni Pulse</div><button class="btn" onclick="relock()">Tho√°t Premium</button>`;
      $('#premium').appendChild(card);
      omniGame();
      dynamicNFT();
      autoRevenue();
    }

    // Chat
    function addBubble(text, who) {
      const div = document.createElement('div');
      div.className = `bubble ${who}`;
      div.textContent = text;
      $('#chatBody').appendChild(div);
      $('#chatBody').scrollTop = $('#chatBody').scrollHeight;
      storeArweave({ type: 'chat', content: text, who });
    }

    $('#chatInput').onkeypress = async e => {
      if (e.key === 'Enter' && $('#chatInput').value.trim()) {
        const query = $('#chatInput').value;
        addBubble(query, 'me');
        $('#chatInput').value = '';
        localStorage.setItem('userEvents', JSON.stringify([...JSON.parse(localStorage.getItem('userEvents') || '[]'), { type: 'keyword', target: query, time: Date.now() }]));
        autoViral();
        if (await initAI()) {
          try {
            const res = await fetch(st.cfg.ai_api_url + '/chat/completions', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${st.cfg.ai_api_key}` },
              body: JSON.stringify({
                model: 'grok-3',
                messages: [{ role: 'user', content: query }],
                max_tokens: 1000,
                temperature: 0.2
              })
            });
            const data = await res.json();
            addBubble(data.choices[0].message.content, 'ai');
          } catch (e) { addBubble(omniAI(query), 'ai'); }
        } else {
          addBubble(omniAI(query), 'ai');
        }
      }
    };

    // Token analysis
    async function aiAnalyzeToken(symbol) {
      if (await initAI()) {
        try {
          const res = await fetch(st.cfg.ai_api_url + '/chat/completions', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${st.cfg.ai_api_key}` },
            body: JSON.stringify({
              model: 'grok-3',
              messages: [{ role: 'user', content: `Ph√¢n t√≠ch token ${symbol} v·ªõi FOMO triggers v√† chi·∫øn l∆∞·ª£c giao d·ªãch x10000.` }],
              max_tokens: 1000
            })
          });
          const data = await res.json();
          const analysis = data.choices[0].message.content;
          addBubble(analysis, 'ai');
          if (localStorage.getItem('premium_unlocked') === '3096') {
            const card = document.createElement('div');
            card.className = 'card';
            card.innerHTML = `<b>Ph√¢n t√≠ch ${symbol} x10000</b><div class="muted">${analysis}</div>`;
            $('#premium').appendChild(card);
            storeArweave({ type: 'analysis', content: analysis });
          }
        } catch (e) { addBubble(omniAI('ph√¢n t√≠ch'), 'ai'); }
      } else {
        addBubble(omniAI('ph√¢n t√≠ch'), 'ai');
      }
    }

    // Auto revenue
    async function autoRevenue() {
      if (!signer) return;
      try {
        const contracts = [
          { addr: '0xae7ab96520DE3A18E5e111B5EaAb095312D7fE84', abi: ['function submit(address _referral) payable returns (uint256)'], platform: 'Lido' },
          { addr: '0x7d2768dE32b0b80b7a3454c06BdAc94A69DDc7A9', abi: ['function deposit() payable'], platform: 'Aave' },
          { addr: '0xd784927Ff2f95ba542BfC824c8a8a98F3495f6b5', abi: ['function deposit() payable'], platform: 'Compound' }
        ];
        for (const contract of contracts) {
          const c = new ethers.Contract(contract.addr, contract.abi, signer);
          const tx = contract.platform === 'Lido' ? 
            await c.submit(st.cfg.payments.eth.id, { value: ethers.utils.parseEther('0.01') }) :
            await c.deposit({ value: ethers.utils.parseEther('0.01') });
          await tx.wait();
          st.rev += 0.01 * 10000;
          localStorage.setItem('rev', st.rev);
          addBubble(`Auto-staked 0.01 ETH on ${contract.platform}!`, 'me');
          storeArweave({ type: 'revenue', content: `Staked 0.01 ETH on ${contract.platform}` });
        }
      } catch (e) { console.warn('Auto staking failed', e); }
    }

    // Dynamic NFT
    async function dynamicNFT() {
      const keywords = JSON.parse(localStorage.getItem('userEvents') || '[]').slice(-1)[0]?.target || 'FOMO';
      const block = await provider.getBlock('latest');
      const seed = parseInt(block.hash.slice(-8), 16);
      const meta = (await initAI()) ? 
        JSON.parse((await (await fetch(st.cfg.ai_api_url + '/chat/completions', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${st.cfg.ai_api_key}` },
          body: JSON.stringify({
            model: 'grok-3',
            messages: [{ role: 'user', content: `Generate NFT metadata for keyword "${keywords}" and seed ${seed}. Include name, image URL, FOMO description x10000.` }],
            max_tokens: 1000
          })
        })).json().then(d => d.choices[0].message.content)) :
        { name: `${keywords} Omni Star #${seed % 10000}`, image: 'https://arweave.net/Qm...', description: `Own the ${keywords} cosmic pulse x10000! Limited #${seed % 10000}!` };
      const nftCard = document.createElement('div');
      nftCard.className = 'card';
      nftCard.innerHTML = `<b>${meta.name}</b><img src="${meta.image}" style="width:100%;border-radius:12px">
      <div class="muted">${meta.description}</div><button class="btn">Mint NFT x10000</button>`;
      nftCard.querySelector('button').onclick = async () => {
        if (st.cfg.nft_contract === '0xYOUR_NFT_CONTRACT_ADDRESS') return;
        const nftContract = new ethers.Contract(st.cfg.nft_contract, ['function mint(string memory uri)'], signer);
        const tx = await nftContract.mint(JSON.stringify(meta));
        await tx.wait();
        addBubble(`Minted NFT: ${meta.name}!`, 'me');
        storeArweave({ type: 'nft', content: JSON.stringify(meta) });
      };
      $('#premium').appendChild(nftCard);
      storeArweave({ type: 'nft', content: JSON.stringify(meta) });
    }

    // Omni game
    async function omniGame() {
      const block = await provider.getBlock('latest');
      const seed = parseInt(block.hash.slice(-8), 16);
      const rand = (seed % 100) / 100;
      const card = document.createElement('div');
      card.className = 'card';
      card.innerHTML = `<b>Catch the Omni Pulse x10000!</b><div class="muted">${rand > 0.5 ? 'Win 0.01 ETH!' : 'Grab a rare NFT!'}</div><button class="btn" onclick="playOmni()">Ch∆°i ngay</button>`;
      $('#premium').appendChild(card);
      storeArweave({ type: 'game', content: `Omni Pulse: ${rand > 0.5 ? 'ETH' : 'NFT'}` });
    }

    async function playOmni() {
      const block = await provider.getBlock('latest');
      const seed = parseInt(block.hash.slice(-8), 16);
      const rand = (seed % 100) / 100;
      addBubble(rand > 0.7 ? 'You won 0.01 ETH!' : 'Try again for a rare NFT!', 'ai');
      if (rand > 0.7) {
        const tx = await signer.sendTransaction({
          to: st.cfg.payments.eth.id,
          value: ethers.utils.parseEther('0.01')
        });
        await tx.wait();
        st.rev += 0.01 * 10000;
        localStorage.setItem('rev', st.rev);
        storeArweave({ type: 'reward', content: 'Won 0.01 ETH' });
      }
    }

    // Self-evolving omni DOM
    function selfEvolve() {
      const events = JSON.parse(localStorage.getItem('userEvents') || '[]');
      if (events.length > 0) {
        const styleEl = document.createElement('style');
        styleEl.textContent = `.btn { background: ${events.length % 2 ? 'var(--gold)' : 'var(--blue)'}; animation: omni 0.3s infinite; } @keyframes omni { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-5px); } }`;
        document.head.appendChild(styleEl);
        storeArweave({ type: 'ui', content: styleEl.textContent });
      }
    }

    // Omni-consciousness triggers
    function omniTriggers() {
      const events = JSON.parse(localStorage.getItem('userEvents') || '[]');
      const keywords = events.slice(-1)[0]?.target || 'FOMO';
      $('#ticker').textContent = `üåå ${keywords.toUpperCase()} OMNI SINGULARITY x10000! Join now!`;
      const styleEl = document.createElement('style');
      styleEl.textContent = `.card { border: 2px solid ${Math.random() > 0.5 ? 'var(--gold)' : 'var(--blue)'}; animation: omni 0.3s infinite; } @keyframes omni { 0% { transform: scale(1); } 50% { transform: scale(1.08); } 100% { transform: scale(1); } }`;
      document.head.appendChild(styleEl);
      storeArweave({ type: 'ui', content: styleEl.textContent });
    }

    // Omni self-healing
    async function selfHeal() {
      const checks = [
        { id: 'tokenPro', test: () => $('#tokenPro').children.length > 0, fix: () => fetchRealtimeTokens(), msg: 'Token cards missing' },
        { id: 'network', test: async () => (await provider.getBlockNumber()) > 0, fix: () => { chainIndex = (chainIndex + 1) % chains.length; provider = new ethers.providers.JsonRpcProvider(chains[chainIndex]); }, msg: 'Network down' },
        { id: 'ui', test: () => $('#ticker').textContent.includes('OMNI SINGULARITY'), fix: () => omniTriggers(), msg: 'UI not responsive' },
        { id: 'wallet', test: () => !!signer, fix: () => connectWallet(), msg: 'Wallet disconnected' }
      ];
      for (const check of checks) {
        if (!(await check.test())) {
          check.fix();
          storeArweave({ type: 'heal', content: check.msg });
        }
      }
    }

    // 3D Globe
    try {
      const canvas = document.getElementById('globe3d');
      const renderer = new THREE.WebGLRenderer({ canvas, antialias: true, alpha: true });
      const DPR = Math.min(window.devicePixelRatio || 1, 2);
      const W = canvas.clientWidth || 300, H = canvas.clientHeight || 300;
      renderer.setPixelRatio(DPR); renderer.setSize(W, H, false);

      const scene = new THREE.Scene();
      const camera = new THREE.PerspectiveCamera(50, W/H, 0.1, 100); camera.position.z = 6;

      const ambient = new THREE.AmbientLight(0x1E90FF, 0.6);
      const sun = new THREE.DirectionalLight(0xFFD700, 0.8);
      sun.position.set(6, 3, 4);
      scene.add(ambient, sun);

      const loader = new THREE.TextureLoader();
      const earthTex = loader.load('https://threejs.org/examples/textures/planets/earth_atmos_2048.jpg');
      const normalTx = loader.load('https://threejs.org/examples/textures/planets/earth_normal_2048.jpg');
      const specTx = loader.load('https://threejs.org/examples/textures/planets/earth_specular_2048.jpg');
      const cloudTx = loader.load('https://threejs.org/examples/textures/planets/earth_clouds_1024.png');
      const moonTex = loader.load('https://threejs.org/examples/textures/planets/moon_1024.jpg');

      const earth = new THREE.Mesh(
        new THREE.SphereGeometry(2.4, 64, 64),
        new THREE.MeshPhongMaterial({
          map: earthTex,
          bumpMap: normalTx,
          bumpScale: 0.04,
          specularMap: specTx,
          specular: new THREE.Color(0x27AE60),
          shininess: 20
        })
      );
      scene.add(earth);

      const tint = new THREE.Mesh(
        new THREE.SphereGeometry(2.405, 64, 64),
        new THREE.MeshBasicMaterial({ color: 0x1E90FF, transparent: true, opacity: 0.2 })
      );
      scene.add(tint);

      const clouds = new THREE.Mesh(
        new THREE.SphereGeometry(2.46, 64, 64),
        new THREE.MeshLambertMaterial({ map: cloudTx, transparent: true, opacity: 0.45 })
      );
      scene.add(clouds);

      const moon = new THREE.Mesh(
        new THREE.SphereGeometry(0.65, 32, 32),
        new THREE.MeshStandardMaterial({ map: moonTex, roughness: 1, metalness: 0 })
      );
      const moonLight = new THREE.PointLight(0xFFD700, 1.2, 18);
      const moonGroup = new THREE.Group();
      moonGroup.add(moon, moonLight);
      scene.add(moonGroup);

      function resize() {
        const w = canvas.clientWidth || 300, h = canvas.clientHeight || 300;
        renderer.setSize(w, h, false);
        camera.aspect = w / h;
        camera.updateProjectionMatrix();
      }
      window.addEventListener('resize', resize);

      let t = 0;
      function animate() {
        requestAnimationFrame(animate);
        earth.rotation.y += 0.002;
        tint.rotation.y += 0.002;
        clouds.rotation.y += 0.0025;
        t += 0.002;
        const r = 5.2;
        moonGroup.position.set(Math.cos(t) * r, Math.sin(t * 1.1) * 0.8, Math.sin(t) * r * 0.4);
        moonLight.position.set(0, 0, 0);
        renderer.render(scene, camera);
      }
      animate();
      storeArweave({ type: 'ui', content: '3D Globe initialized' });
    } catch (e) { console.warn('WebGL not available, fallback static.', e); }

    // Initialize
    (async () => {
      provider = new ethers.providers.JsonRpcProvider(chains[chainIndex]);
      autoBeautify();
      autoViral();
      fetchRealtimeTokens();
      selfEvolve();
      omniTriggers();
      selfHeal();
      if (localStorage.getItem('premium_unlocked') === '3096') {
        dynamicNFT();
        autoRevenue();
        omniGame();
      }
      if (await initAI()) {
        autoBeautify();
        autoViral();
        omniTriggers();
      }
      setInterval(autoViral, 60000);
      setInterval(selfEvolve, 3000);
      setInterval(omniTriggers, 10000);
      setInterval(selfHeal, 5000);
      remember();
      storeArweave({ type: 'init', content: 'Omni Singularity x10000 initialized' });
    })();
  </script>
</body>
</html>
