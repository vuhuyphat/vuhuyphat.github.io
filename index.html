<!doctype html>
<html lang="vi">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover">
<title>LightUnfold ‚Ä¢ One‚ÄëPaste UltraMaster</title>
<meta name="description" content="D√°n 1 l·∫ßn l√† ch·∫°y: ƒëa k√™nh thanh to√°n, affiliate t·ªëi ∆∞u CTR, feed c∆° h·ªôi VI/EN t·ª± c·∫≠p nh·∫≠t (GitHub/IPNS), si√™u b·ªÅn & an to√†n.">
<meta name="theme-color" content="#0b0f13">
<meta http-equiv="Content-Security-Policy" content="default-src 'self' https: data: blob:; img-src * data: blob:; script-src 'self' https://cdn.jsdelivr.net https://threejs.org 'unsafe-inline'; style-src 'self' 'unsafe-inline'; connect-src *;">
<style>
:root{--bg:#0b0f13;--card:#0f141a;--line:#233041;--txt:#e9eef4;--mut:#a9b8c8;--gold:#ffd700;--btn:#ffd700;--btnTxt:#0b0f13;--ring:rgba(255,215,0,.25);--ok:#16a34a;--warn:#f59e0b;--err:#ef4444}
*{box-sizing:border-box}html,body{height:100%}
body{margin:0;background:radial-gradient(60% 140% at 50% -10%, rgba(109,40,217,.18),transparent 60%),linear-gradient(180deg, rgba(22,163,74,.10),transparent 40%),var(--bg);color:var(--txt);font:16px/1.6 system-ui,-apple-system,Segoe UI,Roboto}
.wrap{max-width:1200px;margin:0 auto;padding:18px}
.card{background:var(--card);border:1px solid var(--line);border-radius:18px;padding:16px;margin:12px 0;box-shadow:0 10px 30px rgba(0,0,0,.28)}
.row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
.grid{display:grid;gap:14px;grid-template-columns:repeat(auto-fit,minmax(280px,1fr))}
.pill{display:inline-flex;align-items:center;gap:8px;padding:7px 12px;border:1px solid var(--line);border-radius:999px;background:#101827}
.badge{display:inline-flex;align-items:center;gap:6px;padding:6px 10px;border:1px solid var(--line);border-radius:999px}
.badge.ok{background:rgba(22,163,74,.15);border-color:#1f3e2b}
.badge.warn{background:rgba(245,158,11,.12);border-color:#3d2e12}
.badge.err{background:rgba(239,68,68,.12);border-color:#3a1212}
.btn{display:inline-flex;align-items:center;gap:8px;padding:11px 14px;border:0;border-radius:12px;font-weight:800;background:var(--btn);color:var(--btnTxt);cursor:pointer;box-shadow:0 0 0 0 var(--ring);transition:.2s}
.btn:hover{transform:translateY(-1px);box-shadow:0 0 0 6px var(--ring)}
.btn.out{background:transparent;color:var(--txt);border:1px solid var(--line)}
.muted{color:var(--mut)} .mono{font-family:ui-monospace,Menlo,Consolas,monospace}
.globe3d{width:300px;height:300px;border-radius:50%;display:block;margin:auto}
.qr{width:180px;height:180px;border-radius:12px;background:#fff}
.paybtn{display:flex;justify-content:space-between;align-items:center;border:1px solid var(--line);border-radius:12px;padding:10px 12px;background:transparent;cursor:pointer}
.paybtn.active{outline:2px solid var(--gold);box-shadow:0 0 0 6px rgba(255,215,0,.18)}
.copy{font-size:13px;border:1px dashed var(--line);border-radius:8px;padding:4px 10px;background:transparent;color:var(--txt);cursor:pointer}
.float-share{position:fixed;right:16px;bottom:16px;display:flex;gap:8px;background:var(--card);border:1px solid var(--line);border-radius:14px;padding:10px;z-index:9}
.tag{display:inline-block;border:1px solid var(--line);border-radius:10px;padding:3px 8px;margin:2px 6px 0 0;color:var(--txt);opacity:.85;font-size:12px}
small.note{color:#a7b4c9}
</style>
</head>
<body>
<div class="wrap">
  <div class="row">
    <span class="pill"><b>LightUnfold ‚Ä¢ UltraMaster</b></span>
    <span class="pill">ENS: <b id="ens">lightunfold.eth</b></span>
    <span class="pill">Heartbeat: <b id="hb">‚Äî</b></span>
    <span class="badge ok" id="statusNet">Online</span>
    <span class="badge warn" id="statusFeed">Feed: m·∫∑c ƒë·ªãnh</span>
    <button class="pill" id="lang">VI/EN</button>
  </div>

  <!-- HERO -->
  <section class="card">
    <div class="row" style="justify-content:space-between">
      <div style="min-width:320px;flex:1">
        <h1 style="margin:6px 0 8px" id="hTitle">M·ªôt l·∫ßn d√°n l√† ch·∫°y</h1>
        <div class="muted" id="tagline">Thanh to√°n ƒëa k√™nh ‚Ä¢ Affiliate t·ªëi ∆∞u CTR ‚Ä¢ Feed VI/EN t·ª± c·∫≠p nh·∫≠t ‚Ä¢ B·ªÅn b·ªâ IPFS/IPNS ‚Ä¢ Kh√¥ng spam</div>
        <div class="row" style="margin-top:12px">
          <a class="btn out" id="ctaB" href="#" target="_blank" rel="noopener">M·ªü Binance Mi·ªÖn Ph√≠ ‚Üó</a>
          <a class="btn out" id="ctaA" href="#" target="_blank" rel="noopener">M·ªü AlgosOne Mi·ªÖn Ph√≠ ‚Üó</a>
        </div>
      </div>
      <div>
        <canvas id="globe3d" class="globe3d"></canvas>
        <div class="muted" style="text-align:center;margin-top:6px" id="globeCap">On‚ÄëChain Earth ¬∑ 3D</div>
      </div>
    </div>
  </section>

  <!-- PAY & AFFILIATE -->
  <section class="grid">
    <div class="card">
      <h3 id="hPay">Thanh to√°n nhanh</h3>
      <div id="payList" class="grid" style="grid-template-columns:1fr"></div>
      <div class="row" style="margin-top:10px">
        <div><b id="idLbl">ID/ƒê·ªãa ch·ªâ:</b> <span id="payAddr" class="mono">‚Äî</span></div>
        <button class="btn out" id="btnCopy">Copy</button>
      </div>
      <div class="row" style="margin-top:10px">
        <div class="qr-wrap" style="border:1px dashed var(--line);border-radius:14px;padding:10px"><img id="qr" class="qr" alt="QR"></div>
        <small class="note" id="payNote">Qu√©t VietQR / v√≠ crypto / PayPal.me. N·ªôi dung chuy·ªÉn: <b>LightUnfold</b>.</small>
      </div>
    </div>
    <div class="card">
      <h3 id="hOffer">∆Øu ƒë√£i n·ªïi b·∫≠t (t·ª± h·ªçc & xoay)</h3>
      <div class="row" id="offerBox"></div>
      <div class="row" style="gap:8px;margin-top:10px">
        <span class="pill" id="tagRegion">Region: ‚Ä¶</span>
        <button class="btn out" data-region="VN">VN</button>
        <button class="btn out" data-region="GLOBAL">Global</button>
        <button class="btn out" data-region="CRYPTO">Crypto</button>
      </div>
      <small class="note" id="offerNote">Thu·∫≠t to√°n Œµ‚Äëgreedy + UCB t·ªëi ∆∞u CTR c·ª•c b·ªô (l∆∞u tr√™n thi·∫øt b·ªã).</small>
    </div>
  </section>

  <!-- FEED: C∆° h·ªôi n·ªïi b·∫≠t -->
  <section class="card" id="secFeed">
    <h3 style="margin:0 0 10px" id="hFeed">üî• C∆° h·ªôi / Tin nhanh</h3>
    <div class="muted" id="feedInfo" style="margin-bottom:8px">Hi·ªÉn th·ªã t·ª©c th√¨ t·ª´ feed VI/EN. Kh√¥ng nh·ªìi b√†i; ∆∞u ti√™n m·ªõi & ch·∫•t l∆∞·ª£ng.</div>
    <div id="feedList" class="grid"></div>
  </section>

  <!-- PREMIUM GATE (tu·ª≥ ch·ªçn) -->
  <section class="card">
    <h3 id="hGate">SuperGate (m·ªü kho√° n·ªôi dung)</h3>
    <div class="row">
      <label><span id="codeLbl">M√£ m·ªü kho√°:</span> <input id="unlockCode" placeholder="Nh·∫≠p m√£‚Ä¶"></label>
      <button class="btn" id="doUnlock">M·ªü kho√°</button>
      <button class="btn out" id="remember">Nh·ªõ m√£</button>
      <span id="uMsg" class="muted"></span>
    </div>
    <div id="opened" class="muted" style="display:none;margin-top:8px">‚úî ƒê√£ m·ªü kho√° ‚Äì n·ªôi dung Premium hi·ªÉn th·ªã.</div>
  </section>

  <div class="card" id="inlet">
    L·ªëi v√†o: <a href="https://vuhuyphat.github.io/" target="_blank" rel="noopener">Web2</a> ‚Ä¢
    <a href="https://lightunfold.eth.limo/" target="_blank" rel="noopener">ENS</a> ‚Äî Trang t·ª± c·∫≠p nh·∫≠t khi feed/JSON ƒë·ªïi (kh√¥ng c·∫ßn ƒë·ªïi CID HTML).
  </div>
</div>

<!-- Floating share -->
<div class="float-share">
  <a id="sh_tg" target="_blank" title="Share Telegram" rel="noopener noreferrer">üì£</a>
  <a id="sh_x"  target="_blank" title="Share X" rel="noopener noreferrer">ùïè</a>
  <a id="sh_fb" target="_blank" title="Share Facebook" rel="noopener noreferrer">f</a>
  <a id="sh_in" target="_blank" title="Share LinkedIn" rel="noopener noreferrer">in</a>
</div>

<script src="https://cdn.jsdelivr.net/npm/three@0.157.0/build/three.min.js"></script>
<script>
/* ===== MULTILANG ‚Ä¢ RESILIENT ENGINE ===== */
const IPNS_ID = 'YOUR_IPNS_ID'; // c√≥ th·ªÉ ƒë·ªÉ tr·ªëng; HTML v·∫´n ch·∫°y
const CONFIG_URLS = [
  'https://raw.githubusercontent.com/vuhuyphat/vuhuyphat.github.io/main/payments.json',
  IPNS_ID ? `https://ipfs.io/ipns/${IPNS_ID}/payments.json` : null,
  IPNS_ID ? `https://cloudflare-ipfs.com/ipns/${IPNS_ID}/payments.json` : null
].filter(Boolean);

// Feed ƒëa ng√¥n ng·ªØ (VI/EN) + ƒëa gateway (GitHub/IPNS)
function feedSources(lang){
  const base = 'https://raw.githubusercontent.com/vuhuyphat/vuhuyphat.github.io/main';
  const file = lang==='en' ? 'feed.en.json' : 'feed.vi.json';
  const arr = [
    `${base}/${file}`,
    IPNS_ID ? `https://ipfs.io/ipns/${IPNS_ID}/${file}` : null,
    IPNS_ID ? `https://cloudflare-ipfs.com/ipns/${IPNS_ID}/${file}` : null
  ].filter(Boolean);
  return arr;
}

/*** Defaults ***/
const defaults = {
  ens:'lightunfold.eth',
  links:{
    binance:'https://www.binance.com/referral/earn-together/refer-in-hotsummer/claim?hl=vi&ref=GRO_20338_9V44N',
    algos:'https://algosone.page.link/MbtR'
  },
  payments:{
    eth:{label:'ETH (ENS)',id:'lightunfold.eth',scheme:'ethereum:'},
    usdt:{label:'USDT (ERC‚Äë20)',id:'0x5da80d0f7e2df3cb0aa73d6a942bbe36b046b8f0'},
    momo:{label:'MoMo',id:'0567892030'},
    bank:{label:'Vietcombank',id:'9567892030|TR·∫¶N VƒÇN V≈®'},
    paypal:{label:'PayPal',id:'vumumabada@gmail.com'}
  },
  premium:{unlock_code:'23061988'}
};

// Seed VI/EN ƒë·ªÉ lu√¥n c√≥ n·ªôi dung (kh√¥ng spam, ch·ªâ 2‚Äì4 m·ª•c)
const FEED_SEED = {
  vi:{
    updated_at:new Date().toISOString(),
    items:[
      {id:'seed-vi-1',title:'M·ªü Binance nh·∫≠n th∆∞·ªüng ‚Äì b·∫Øt nh·ªãp th·ªã tr∆∞·ªùng',body_html:'<p>∆Øu ƒë√£i ng∆∞·ªùi m·ªõi, theo d√µi th·ªã tr∆∞·ªùng, ph√≠ c·∫°nh tranh.</p>',cta:{label:'M·ªü Binance',url:defaults.links.binance},tags:['onboarding','cex'],lang:'vi'},
      {id:'seed-vi-2',title:'AlgosOne ‚Äì T√≠n hi·ªáu & chi·∫øn l∆∞·ª£c AI',body_html:'<p>Nh·∫≠n c·∫£nh b√°o realtime, playbook k·ªãch b·∫£n 2 chi·ªÅu.</p>',cta:{label:'M·ªü AlgosOne',url:defaults.links.algos},tags:['ai','signals'],lang:'vi'}
    ]
  },
  en:{
    updated_at:new Date().toISOString(),
    items:[
      {id:'seed-en-1',title:'Open Binance ‚Äì kickstart your journey',body_html:'<p>New user perks, market tracking, competitive fees.</p>',cta:{label:'Open Binance',url:defaults.links.binance},tags:['onboarding','cex'],lang:'en'},
      {id:'seed-en-2',title:'AlgosOne ‚Äì AI signals & strategies',body_html:'<p>Realtime alerts, two‚Äësided scenarios, disciplined plan.</p>',cta:{label:'Open AlgosOne',url:defaults.links.algos},tags:['ai','signals'],lang:'en'}
    ]
  }
};

const $=s=>document.querySelector(s), $$=s=>document.querySelectorAll(s);
const LS_CFG='onepaste_cfg_v2', LS_FEED_VI='onepaste_feed_vi_v2', LS_FEED_EN='onepaste_feed_en_v2', LS_STATS='onepaste_stats_v2';

function isVN(){ const lang=(navigator.language||'').toLowerCase(); const tz=Intl.DateTimeFormat().resolvedOptions().timeZone||''; return lang.startsWith('vi')||tz.includes('Bangkok')||tz.includes('Ho_Chi_Minh'); }
let LANG=(localStorage.getItem('lang')||(isVN()?'vi':'en'));
function setLang(l){ LANG=l; localStorage.setItem('lang',l); applyLang(); bootFeed(); }

function applyLang(){
  const vi = LANG==='vi';
  $('#hTitle').textContent = vi?'M·ªôt l·∫ßn d√°n l√† ch·∫°y':'One‚Äëpaste and go';
  $('#tagline').textContent = vi?'Thanh to√°n ƒëa k√™nh ‚Ä¢ Affiliate t·ªëi ∆∞u CTR ‚Ä¢ Feed VI/EN t·ª± c·∫≠p nh·∫≠t ‚Ä¢ B·ªÅn b·ªâ IPFS/IPNS ‚Ä¢ Kh√¥ng spam':
                                'Multi‚Äëchannel payments ‚Ä¢ CTR‚Äëoptimized affiliate ‚Ä¢ Auto VI/EN feed ‚Ä¢ IPFS/IPNS resilience ‚Ä¢ No spam';
  $('#hPay').textContent = vi?'Thanh to√°n nhanh':'Payments';
  $('#idLbl').textContent = vi?'ID/ƒê·ªãa ch·ªâ:':'ID/Address:';
  $('#payNote').innerHTML = vi?'Qu√©t VietQR / v√≠ crypto / PayPal.me. N·ªôi dung chuy·ªÉn: <b>LightUnfold</b>.':
                               'Scan VietQR / crypto wallet / PayPal.me. Note: <b>LightUnfold</b>.';
  $('#hOffer').textContent = vi?'∆Øu ƒë√£i n·ªïi b·∫≠t (t·ª± h·ªçc & xoay)':'Featured offers (learn & rotate)';
  $('#offerNote').textContent = vi?'Thu·∫≠t to√°n Œµ‚Äëgreedy + UCB t·ªëi ∆∞u CTR c·ª•c b·ªô (l∆∞u tr√™n thi·∫øt b·ªã).':
                                  'Œµ‚Äëgreedy + UCB bandit (on‚Äëdevice) to optimize CTR.';
  $('#hFeed').textContent = vi?'üî• C∆° h·ªôi / Tin nhanh':'üî• Opportunities / Quick briefs';
  $('#hGate').textContent = vi?'SuperGate (m·ªü kho√° n·ªôi dung)':'SuperGate (unlock content)';
  $('#codeLbl').textContent = vi?'M√£ m·ªü kho√°:':'Unlock code:';
  $('#globeCap').textContent = vi?'Tr√°i ƒê·∫•t On‚ÄëChain ¬∑ 3D':'On‚ÄëChain Earth ¬∑ 3D';
  $('#lang').textContent = vi?'VI/EN':'EN/VI';
}
applyLang();
$('#lang').onclick=()=>setLang(LANG==='vi'?'en':'vi');
setInterval(()=>{ $('#hb').textContent=new Date().toLocaleTimeString(); },1000);

/*** Net, fetch, sanitize ***/
function netBadge(ok){ const el=$('#statusNet'); if(!el) return; el.textContent = ok?'Online':'Offline'; el.className='badge '+(ok?'ok':'err'); }
window.addEventListener('online',()=>netBadge(true)); window.addEventListener('offline',()=>netBadge(false)); netBadge(navigator.onLine);
function timeout(ms){ return new Promise((_,rej)=>setTimeout(()=>rej(new Error('TIMEOUT')),ms)); }
async function fetchJSON(url,ms=7000){ return Promise.race([fetch(url,{cache:'no-store'}).then(r=>r.ok?r.json():Promise.reject(new Error(r.status))), timeout(ms)]); }
async function trySources(urls, cacheKey, fallback){
  for(const u of urls){ try{ const d=await fetchJSON(u); localStorage.setItem(cacheKey,JSON.stringify(d)); return {data:d, source:u}; }catch(e){} }
  try{ const c=localStorage.getItem(cacheKey); if(c) return {data:JSON.parse(c), source:'cache'}; }catch(e){}
  return {data:fallback, source:'default'};
}
function sanitize(html){
  try{
    const tmp=document.createElement('div'); tmp.innerHTML=html||'';
    const ALLOWED=new Set(['B','I','EM','STRONG','P','BR','UL','OL','LI','A','CODE','PRE','SPAN','SMALL']);
    (function walk(n){ [...n.children].forEach(ch=>{
      if(!ALLOWED.has(ch.tagName)){ ch.replaceWith(document.createTextNode(ch.textContent||'')); return; }
      [...ch.attributes].forEach(a=>{ if(!(ch.tagName==='A' && ['href','target','rel'].includes(a.name.toLowerCase()))) ch.removeAttribute(a.name); });
      if(ch.tagName==='A'){ try{ const u=new URL(ch.getAttribute('href'),location.href); if(!/^https?:/i.test(u.protocol)) ch.removeAttribute('href'); }catch(_){ ch.removeAttribute('href'); } ch.setAttribute('rel','noopener noreferrer'); ch.setAttribute('target','_blank'); }
      walk(ch);
    }); })(tmp);
    return tmp.innerHTML;
  }catch(_){ return ''; }
}

/*** CTR learning ***/
function stats(){ try{return JSON.parse(localStorage.getItem(LS_STATS)||'{}')}catch{return{}} }
function saveStats(s){ localStorage.setItem(LS_STATS, JSON.stringify(s)); }
function region(){ const v=localStorage.getItem('ab_region'); if(v) return v; return isVN()?'VN':'GLOBAL'; }
function banditPick(pool){
  const s=stats(); s.stats=s.stats||{}; s.total=s.total||0; const eps=0.12;
  if(Math.random()<eps) return pool[Math.floor(Math.random()*pool.length)];
  let best=pool[0],score=-1;
  for(const o of pool){ const st=s.stats[o.id]||{}; const ctr=(st.c||0)/Math.max(1,(st.v||0));
    const ucb=ctr+Math.sqrt(2*Math.log(1+(s.total||1))/Math.max(1,(st.v||0))); if(ucb>score){score=ucb;best=o;} }
  return best;
}
function markView(id){ const s=stats(); s.stats=s.stats||{}; s.stats[id]=s.stats[id]||{v:0,c:0}; s.stats[id].v++; s.total=(s.total||0)+1; saveStats(s); }
function markClick(id){ const s=stats(); s.stats=s.stats||{}; s.stats[id]=s.stats[id]||{v:0,c:0}; s.stats[id].c++; saveStats(s); }

/*** Payments & Offers ***/
function setQR(text){ $('#qr').src=`https://api.qrserver.com/v1/create-qr-code/?size=340x340&data=${encodeURIComponent(text)}`; }
function copy(txt){ return navigator.clipboard.writeText(txt).then(()=>alert(LANG==='vi'?'ƒê√£ sao ch√©p.':'Copied.')).catch(()=>alert(LANG==='vi'?'Thi·∫øt b·ªã ch·∫∑n clipboard.':'Clipboard blocked.')); }

function paintPayments(cfg){
  const pays=cfg.payments||{}; const list=$('#payList'); list.innerHTML=''; const rows=[];
  const map={
    eth:v=>({title:'ETH (ENS/Address)',id:v.id,qr:(v.scheme||'ethereum:')+(v.id||'')}),
    usdt:v=>({title:'USDT (ERC‚Äë20)',id:v.id,qr:v.id}),
    momo:v=>({title:'MoMo',id:v.id,qr:v.id}),
    bank:v=>{ const [acc,name]=(v.id||'').split('|'); return {title:'Vietcombank',id:`${acc} ‚Ä¢ ${name||''}`,qr:`VCB:${acc}?memo=LightUnfold&name=${encodeURIComponent(name||'')}`}},
    paypal:v=>({title:'PayPal',id:v.id,qr:`paypal.me/${encodeURIComponent((v.id||'').split('@')[0])}`})
  };
  Object.entries(map).forEach(([k,fn])=>{
    if(!pays[k]) return; const norm=fn(pays[k]); const row=document.createElement('div'); row.className='paybtn';
    row.innerHTML=`<div><b>${norm.title}</b><div class="muted mono">${norm.id}</div></div><button class="copy">Copy</button>`;
    row.onclick=()=>{ $('#payAddr').textContent=norm.id; setQR(norm.qr); $$('.paybtn').forEach(x=>x.classList.remove('active')); row.classList.add('active'); };
    row.querySelector('.copy').onclick=(e)=>{ e.stopPropagation(); copy(norm.id); };
    list.appendChild(row); rows.push(row);
  });
  if(rows[0]) rows[0].click();
  $('#btnCopy').onclick=()=>copy($('#payAddr').textContent||'');
}
function paintOffers(cfg){
  const r=region(); $('#tagRegion').textContent='Region: '+r;
  const OFFERS=[
    {id:'binance',title:LANG==='vi'?'M·ªü Binance Mi·ªÖn Ph√≠':'Open Binance Free',url:cfg.links?.binance,regions:['VN','GLOBAL']},
    {id:'algos',title:LANG==='vi'?'M·ªü AlgosOne Mi·ªÖn Ph√≠':'Open AlgosOne Free',url:cfg.links?.algos,regions:['GLOBAL','CRYPTO','VN']}
  ].filter(o=>o.url);
  const pool=OFFERS.filter(o=>o.regions.includes(r)) || OFFERS;
  const pick=banditPick(pool.length?pool:OFFERS); const box=$('#offerBox');
  box.innerHTML=`<a class="btn out" id="offer" href="${pick.url}" target="_blank" rel="noopener">üî• ${pick.title}</a>
                 ${cfg.links?.binance?`<a class="btn out" href="${cfg.links.binance}" target="_blank" rel="noopener">üöÄ Binance</a>`:''}
                 ${cfg.links?.algos?`<a class="btn out" href="${cfg.links.algos}" target="_blank" rel="noopener">üåê AlgosOne</a>`:''}`;
  $('#offer').addEventListener('click',()=>markClick(pick.id)); markView(pick.id);
  if(cfg.links?.binance) $('#ctaB').href=cfg.links.binance; if(cfg.links?.algos) $('#ctaA').href=cfg.links.algos;
}
function bindRegionButtons(){ $$('button[data-region]').forEach(b=>b.onclick=()=>{ localStorage.setItem('ab_region', b.dataset.region); location.reload(); }); }

/*** Feed loader (multilang, no‚Äëspam): ∆∞u ti√™n 6‚Äì8 m·ª•c g·∫ßn nh·∫•t, b·ªè tr√πng ID ***/
function sanitizeFeed(data){
  const seen=new Set(); const items=(data.items||[]).filter(x=>{
    if(!x || !x.id || seen.has(x.id)) return false; seen.add(x.id); return true;
  });
  // Gi·ªõi h·∫°n hi·ªÉn th·ªã ƒë·ªÉ kh√¥ng ‚Äúnh·ªìi b√†i‚Äù
  return {updated_at:data.updated_at||new Date().toISOString(), items: items.slice(0,8)};
}
function renderFeed(feed, source){
  $('#statusFeed').textContent = 'Feed: ' + (source==='default'?(LANG==='vi'?'m·∫∑c ƒë·ªãnh':'default'): source==='cache'?'cache':'remote');
  $('#statusFeed').className = 'badge ' + (source==='default'?'warn':'ok');
  $('#feedInfo').textContent = (LANG==='vi'?'C·∫≠p nh·∫≠t: ':'Updated: ') + new Date(feed.updated_at).toLocaleString() + ' ‚Ä¢ source: ' + source;
  const box=$('#feedList'); box.innerHTML='';
  feed.items.forEach(it=>{
    const card=document.createElement('div'); card.className='card';
    const body=sanitize(it.body_html||''); const tags=(it.tags||[]).map(t=>`<span class="tag">#${t}</span>`).join(' ');
    card.innerHTML=`<b>${it.title||''}</b><div class="muted" style="margin:6px 0">${tags}</div><div>${body}</div>
    ${it.cta?.url?`<div class="row" style="margin-top:8px"><a class="btn out" href="${it.cta.url}" target="_blank" rel="noopener">${it.cta.label|| (LANG==='vi'?'Xem':'Open')}</a></div>`:''}`;
    box.appendChild(card);
  });
}

/*** Loaders ***/
async function loadConfig(){
  const {data} = await trySources(CONFIG_URLS, LS_CFG, defaults);
  return {...defaults, ...data, payments:{...defaults.payments, ...(data.payments||{})}};
}
async function loadFeedFor(lang){
  const urls = feedSources(lang);
  const cacheKey = lang==='en'?LS_FEED_EN:LS_FEED_VI;
  const fallback = FEED_SEED[lang] || FEED_SEED.vi;
  const {data, source} = await trySources(urls, cacheKey, fallback);
  return {feed: sanitizeFeed(data), source};
}
async function bootFeed(){
  const {feed, source} = await loadFeedFor(LANG);
  renderFeed(feed, source);
}

/*** Gate, Share, 3D ***/
function bindGate(cfg){
  const SECRET=String(cfg.premium?.unlock_code||'');
  $('#doUnlock').onclick=()=>{ const ok=(String($('#unlockCode').value||'').trim()===SECRET);
    $('#uMsg').textContent= ok ? (LANG==='vi'?'‚úÖ ƒê√£ m·ªü kho√°':'‚úÖ Unlocked') : (LANG==='vi'?'‚ùå Sai m√£':'‚ùå Wrong code');
    $('#opened').style.display = ok ? 'block':'none';
    if(ok) localStorage.setItem('premium_unlocked','1');
  };
  $('#remember').onclick=()=> localStorage.setItem('remember_code',$('#unlockCode').value||'');
  if(localStorage.getItem('premium_unlocked')==='1') $('#opened').style.display='block';
}
(function share(){
  const base=location.origin+location.pathname; const peer=localStorage.getItem('peer_id')||Math.random().toString(36).slice(2);
  localStorage.setItem('peer_id',peer); const myRef=`${base}?ref=${peer}`;
  const t=encodeURIComponent(document.title), u=encodeURIComponent(myRef);
  const map={sh_tg:`https://t.me/share/url?url=${u}&text=${t}`,sh_x:`https://twitter.com/intent/tweet?text=${t}&url=${u}`,sh_fb:`https://www.facebook.com/sharer/sharer.php?u=${u}`,sh_in:`https://www.linkedin.com/sharing/share-offsite/?url=${u}`};
  for(const id in map){ const el=document.getElementById(id); if(el) el.href=map[id]; }
})();
(function earth(){
  try{
    const canvas=document.getElementById('globe3d'); const pref=window.matchMedia('(prefers-reduced-motion: reduce)').matches;
    const renderer=new THREE.WebGLRenderer({canvas,antialias:true,alpha:true});
    const DPR=Math.min(window.devicePixelRatio||1,2); const W=canvas.clientWidth||300,H=canvas.clientHeight||300;
    renderer.setPixelRatio(DPR); renderer.setSize(W,H,false);
    const scene=new THREE.Scene(); const camera=new THREE.PerspectiveCamera(50,W/H,0.1,100); camera.position.z=6;
    scene.add(new THREE.AmbientLight(0x9fc9ff,0.55), new THREE.DirectionalLight(0xffffff,0.95));
    const loader=new THREE.TextureLoader();
    const earth=new THREE.Mesh(new THREE.SphereGeometry(2.4,64,64),
      new THREE.MeshPhongMaterial({map:loader.load('https://threejs.org/examples/textures/planets/earth_atmos_2048.jpg')}));
    scene.add(earth);
    (function anim(){ if(!pref) earth.rotation.y+=0.0024; renderer.render(scene,camera); requestAnimationFrame(anim); })();
  }catch(e){ $('#globeCap').textContent='‚Äî'; }
})();

/*** BOOT ***/
document.getElementById('ens').textContent=defaults.ens;
(async function start(){
  try{
    const cfg = await loadConfig();
    paintPayments(cfg);
    paintOffers(cfg);
    bindRegionButtons();
    bindGate(cfg);
    await bootFeed();
  }catch(e){ console.warn('Boot failed', e); $('#statusFeed').textContent='Feed: l·ªói'; $('#statusFeed').className='badge err'; }
})();
</script>

<!-- Service Worker (cache nh·∫π) -->
<script>
if('serviceWorker' in navigator){
  const sw = `
    const CACHE='onepaste-v2';
    self.addEventListener('install',e=>{e.waitUntil(caches.open(CACHE).then(c=>c.addAll(['./'])) )});
    self.addEventListener('fetch',e=>{
      e.respondWith(
        caches.match(e.request).then(r=>r||fetch(e.request).then(res=>{
          const copy=res.clone(); caches.open(CACHE).then(c=>c.put(e.request,copy)); return res;
        }).catch(()=>r))
      );
    });
  `;
  const blob = new Blob([sw],{type:'text/javascript'}); const url = URL.createObjectURL(blob);
  navigator.serviceWorker.register(url).catch(()=>{});
}
</script>
</body>
</html>
