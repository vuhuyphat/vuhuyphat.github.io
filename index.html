<!doctype html>
<html lang="vi">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover">
<title>LightUnfold ‚Ä¢ One‚ÄëPaste UltraMaster</title>
<meta name="description" content="M·ªôt l·∫ßn d√°n l√† ch·∫°y: ƒëa k√™nh thanh to√°n, affiliate t·ªëi ∆∞u CTR, feed c∆° h·ªôi t·ª± c·∫≠p nh·∫≠t (GitHub/IPNS), b·ªÅn b·ªâ & an to√†n.">
<meta name="theme-color" content="#0b0f13">
<!-- G·ª£i √Ω CSP ·ªü m·ª©c th·∫≠n tr·ªçng (tr√¨nh duy·ªát c√≥ th·ªÉ b·ªè qua khi ·ªü GitHub Pages) -->
<meta http-equiv="Content-Security-Policy" content="default-src 'self' https: data: blob:; img-src * data: blob:; script-src 'self' https://cdn.jsdelivr.net https://threejs.org 'unsafe-inline'; style-src 'self' 'unsafe-inline'; connect-src *;">

<style>
:root{--bg:#0b0f13;--card:#0f141a;--line:#233041;--txt:#e9eef4;--mut:#a9b8c8;--gold:#ffd700;--btn:#ffd700;--btnTxt:#0b0f13;--ring:rgba(255,215,0,.25);--ok:#16a34a;--warn:#f59e0b;--err:#ef4444}
*{box-sizing:border-box}html,body{height:100%}
body{margin:0;background:radial-gradient(60% 140% at 50% -10%, rgba(109,40,217,.18),transparent 60%),linear-gradient(180deg, rgba(22,163,74,.10),transparent 40%),var(--bg);color:var(--txt);font:16px/1.6 system-ui,-apple-system,Segoe UI,Roboto}
.wrap{max-width:1200px;margin:0 auto;padding:18px}
.card{background:var(--card);border:1px solid var(--line);border-radius:18px;padding:16px;margin:12px 0;box-shadow:0 10px 30px rgba(0,0,0,.28)}
.row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
.grid{display:grid;gap:14px;grid-template-columns:repeat(auto-fit,minmax(280px,1fr))}
.pill{display:inline-flex;align-items:center;gap:8px;padding:7px 12px;border:1px solid var(--line);border-radius:999px;background:#101827}
.badge{display:inline-flex;align-items:center;gap:6px;padding:6px 10px;border:1px solid var(--line);border-radius:999px}
.badge.ok{background:rgba(22,163,74,.15);border-color:#1f3e2b}
.badge.warn{background:rgba(245,158,11,.12);border-color:#3d2e12}
.badge.err{background:rgba(239,68,68,.12);border-color:#3a1212}
.btn{display:inline-flex;align-items:center;gap:8px;padding:11px 14px;border:0;border-radius:12px;font-weight:800;background:var(--btn);color:var(--btnTxt);cursor:pointer;box-shadow:0 0 0 0 var(--ring);transition:.2s}
.btn:hover{transform:translateY(-1px);box-shadow:0 0 0 6px var(--ring)}
.btn.out{background:transparent;color:var(--txt);border:1px solid var(--line)}
.muted{color:var(--mut)} .mono{font-family:ui-monospace,Menlo,Consolas,monospace}
.globe3d{width:300px;height:300px;border-radius:50%;display:block;margin:auto}
.qr{width:180px;height:180px;border-radius:12px;background:#fff}
.paybtn{display:flex;justify-content:space-between;align-items:center;border:1px solid var(--line);border-radius:12px;padding:10px 12px;background:transparent;cursor:pointer}
.paybtn.active{outline:2px solid var(--gold);box-shadow:0 0 0 6px rgba(255,215,0,.18)}
.copy{font-size:13px;border:1px dashed var(--line);border-radius:8px;padding:4px 10px;background:transparent;color:var(--txt);cursor:pointer}
.float-share{position:fixed;right:16px;bottom:16px;display:flex;gap:8px;background:var(--card);border:1px solid var(--line);border-radius:14px;padding:10px;z-index:9}
.tag{display:inline-block;border:1px solid var(--line);border-radius:10px;padding:3px 8px;margin:2px 6px 0 0;color:var(--txt);opacity:.85;font-size:12px}
small.note{color:#a7b4c9}
</style>
</head>
<body>
<div class="wrap">
  <div class="row">
    <span class="pill"><b>LightUnfold ‚Ä¢ UltraMaster</b></span>
    <span class="pill">ENS: <b id="ens">lightunfold.eth</b></span>
    <span class="pill">Heartbeat: <b id="hb">‚Äî</b></span>
    <span class="badge ok" id="statusNet">Online</span>
    <span class="badge warn" id="statusFeed">Feed: m·∫∑c ƒë·ªãnh</span>
    <button class="pill" id="lang">VI/EN</button>
  </div>

  <!-- HERO -->
  <section class="card">
    <div class="row" style="justify-content:space-between">
      <div style="min-width:320px;flex:1">
        <h1 style="margin:6px 0 8px">M·ªôt l·∫ßn d√°n l√† ch·∫°y</h1>
        <div class="muted" id="tagline">Thanh to√°n ƒëa k√™nh ‚Ä¢ Affiliate t·ªëi ∆∞u CTR ‚Ä¢ Feed c∆° h·ªôi t·ª± c·∫≠p nh·∫≠t ‚Ä¢ B·ªÅn b·ªâ IPFS/IPNS</div>
        <div class="row" style="margin-top:12px">
          <a class="btn out" id="ctaB" href="#" target="_blank" rel="noopener">M·ªü Binance Mi·ªÖn Ph√≠ ‚Üó</a>
          <a class="btn out" id="ctaA" href="#" target="_blank" rel="noopener">M·ªü AlgosOne Mi·ªÖn Ph√≠ ‚Üó</a>
        </div>
      </div>
      <div>
        <canvas id="globe3d" class="globe3d"></canvas>
        <div class="muted" style="text-align:center;margin-top:6px" id="globeCap">On‚ÄëChain Earth ¬∑ 3D</div>
      </div>
    </div>
  </section>

  <!-- PAY & AFFILIATE -->
  <section class="grid">
    <div class="card">
      <h3>Thanh to√°n nhanh</h3>
      <div id="payList" class="grid" style="grid-template-columns:1fr"></div>
      <div class="row" style="margin-top:10px">
        <div><b>ID/ƒê·ªãa ch·ªâ:</b> <span id="payAddr" class="mono">‚Äî</span></div>
        <button class="btn out" id="btnCopy">Copy</button>
      </div>
      <div class="row" style="margin-top:10px">
        <div class="qr-wrap" style="border:1px dashed var(--line);border-radius:14px;padding:10px"><img id="qr" class="qr" alt="QR"></div>
        <small class="note">Qu√©t VietQR / v√≠ crypto / PayPal.me. N·ªôi dung chuy·ªÉn: <b>LightUnfold</b>.</small>
      </div>
    </div>
    <div class="card">
      <h3>∆Øu ƒë√£i n·ªïi b·∫≠t (t·ª± h·ªçc & xoay)</h3>
      <div class="row" id="offerBox"></div>
      <div class="row" style="gap:8px;margin-top:10px">
        <span class="pill" id="tagRegion">Region: ‚Ä¶</span>
        <button class="btn out" data-region="VN">VN</button>
        <button class="btn out" data-region="GLOBAL">Global</button>
        <button class="btn out" data-region="CRYPTO">Crypto</button>
      </div>
      <small class="note">Thu·∫≠t to√°n Œµ‚Äëgreedy + UCB t·ªëi ∆∞u CTR c·ª•c b·ªô (l∆∞u tr√™n thi·∫øt b·ªã).</small>
    </div>
  </section>

  <!-- FEED: C∆° h·ªôi n·ªïi b·∫≠t -->
  <section class="card" id="secFeed">
    <h3 style="margin:0 0 10px">üî• C∆° h·ªôi / Tin nhanh</h3>
    <div class="muted" id="feedInfo" style="margin-bottom:8px">Hi·ªÉn th·ªã t·ª©c th√¨ t·ª´ feed m·∫∑c ƒë·ªãnh. N·∫øu c√≥ feed JSON ngo√†i, trang s·∫Ω t·ª± c·∫≠p nh·∫≠t.</div>
    <div id="feedList" class="grid"></div>
  </section>

  <!-- PREMIUM GATE (tu·ª≥ ch·ªçn) -->
  <section class="card">
    <h3>SuperGate (m·ªü kho√° n·ªôi dung)</h3>
    <div class="row">
      <label>M√£ m·ªü kho√°: <input id="unlockCode" placeholder="Nh·∫≠p m√£‚Ä¶"></label>
      <button class="btn" id="doUnlock">M·ªü kho√°</button>
      <button class="btn out" id="remember">Nh·ªõ m√£</button>
      <span id="uMsg" class="muted"></span>
    </div>
    <div id="opened" class="muted" style="display:none;margin-top:8px">‚úî ƒê√£ m·ªü kho√° ‚Äì n·ªôi dung Premium hi·ªÉn th·ªã.</div>
  </section>

  <div class="card">
    L·ªëi v√†o: <a href="https://vuhuyphat.github.io/" target="_blank" rel="noopener">Web2</a> ‚Ä¢
    <a href="https://lightunfold.eth.limo/" target="_blank" rel="noopener">ENS</a> ‚Äî Trang t·ª± c·∫≠p nh·∫≠t khi JSON thay ƒë·ªïi (kh√¥ng c·∫ßn ƒë·ªïi CID HTML).
  </div>
</div>

<!-- Floating share -->
<div class="float-share">
  <a id="sh_tg" target="_blank" title="Share Telegram" rel="noopener noreferrer">üì£</a>
  <a id="sh_x"  target="_blank" title="Share X" rel="noopener noreferrer">ùïè</a>
  <a id="sh_fb" target="_blank" title="Share Facebook" rel="noopener noreferrer">f</a>
  <a id="sh_in" target="_blank" title="Share LinkedIn" rel="noopener noreferrer">in</a>
</div>

<!-- Three.js (nh·∫π) -->
<script src="https://cdn.jsdelivr.net/npm/three@0.157.0/build/three.min.js"></script>
<script>
/* ================= ONE-PASTE ENGINE (Hardened) =================
   ‚Äì N·∫°p CONFIG & FEED ƒëa ngu·ªìn (GitHub/IPNS) + fallback cache.
   ‚Äì Sanitize body_html ƒë·ªÉ tr√°nh XSS khi ƒë·ªçc feed ngo√†i.
   ‚Äì T·ªëi ∆∞u CTR affiliate (Œµ-greedy + UCB), ƒëa k√™nh thanh to√°n.
   ‚Äì 3D Earth t·ª± t·∫Øt khi thi·∫øt b·ªã y·∫øu; share viral; service worker cache nh·∫π.
================================================================= */

/*** 1) ‚Äî‚Äî C·∫§U H√åNH NGU·ªíN ƒê·ªòNG (c√≥ th·ªÉ ƒë·ªÉ nguy√™n, HTML v·∫´n ch·∫°y v·ªõi defaults) ***/
// Th√™m IPNS c·ªßa b·∫°n n·∫øu c√≥: thay YOUR_IPNS_ID
const IPNS_ID = 'YOUR_IPNS_ID';

// Nhi·ªÅu ngu·ªìn cho CONFIG (th·ª© t·ª± ∆∞u ti√™n)
const CONFIG_URLS = [
  'https://raw.githubusercontent.com/vuhuyphat/vuhuyphat.github.io/main/payments.json',
  IPNS_ID ? `https://ipfs.io/ipns/${IPNS_ID}/payments.json` : null,
  IPNS_ID ? `https://cloudflare-ipfs.com/ipns/${IPNS_ID}/payments.json` : null,
  IPNS_ID ? `https://gateway.pinata.cloud/ipns/${IPNS_ID}/payments.json` : null
].filter(Boolean);

// Nhi·ªÅu ngu·ªìn cho FEED (th·ª© t·ª± ∆∞u ti√™n)
const FEED_URLS = [
  'https://raw.githubusercontent.com/vuhuyphat/vuhuyphat.github.io/main/feed.json',
  IPNS_ID ? `https://ipfs.io/ipns/${IPNS_ID}/feed.json` : null,
  IPNS_ID ? `https://cloudflare-ipfs.com/ipns/${IPNS_ID}/feed.json` : null,
  IPNS_ID ? `https://gateway.pinata.cloud/ipns/${IPNS_ID}/feed.json` : null
].filter(Boolean);

/*** 2) ‚Äî‚Äî DEFAULTS AN TO√ÄN (hi·ªÉn th·ªã ngay, kh√¥ng c·∫ßn ngu·ªìn ngo√†i) ***/
const defaults = {
  ens: 'lightunfold.eth',
  links: {
    binance: 'https://www.binance.com/referral/earn-together/refer-in-hotsummer/claim?hl=vi&ref=GRO_20338_9V44N',
    algos: 'https://algosone.page.link/MbtR'
  },
  payments: {
    eth:   { label:'ETH (ENS)',     id:'lightunfold.eth', scheme:'ethereum:' },
    usdt:  { label:'USDT (ERC‚Äë20)', id:'0x5da80d0f7e2df3cb0aa73d6a942bbe36b046b8f0' },
    momo:  { label:'MoMo',          id:'0567892030' },
    bank:  { label:'Vietcombank',   id:'9567892030|TR·∫¶N VƒÇN V≈®' },
    paypal:{ label:'PayPal',        id:'vumumabada@gmail.com' }
  },
  premium: { unlock_code: '23061988' }
};

const FEED_DEFAULT = {
  updated_at: new Date().toISOString(),
  items: [
    { id:"seed-1", title:"M·ªü Binance nh·∫≠n th∆∞·ªüng ‚Äì b·∫Øt nh·ªãp th·ªã tr∆∞·ªùng",
      body_html:"<p>M·ªü t√†i kho·∫£n mi·ªÖn ph√≠, theo d√µi th·ªã tr∆∞·ªùng, nh·∫≠n ∆∞u ƒë√£i ng∆∞·ªùi m·ªõi.</p>",
      cta:{label:"M·ªü Binance", url:defaults.links.binance}, tags:["onboarding","cex"], lang:"vi" },
    { id:"seed-2", title:"AlgosOne ‚Äì t√≠n hi·ªáu & chi·∫øn l∆∞·ª£c AI",
      body_html:"<p>Kh·ªüi ƒë·ªông t√†i kho·∫£n ƒë·ªÉ nh·∫≠n c·∫£nh b√°o th·ªùi gian th·ª±c v√† chi·∫øn l∆∞·ª£c g·ª£i √Ω.</p>",
      cta:{label:"M·ªü AlgosOne", url:defaults.links.algos}, tags:["ai","signals"], lang:"vi" }
  ]
};

/*** 3) ‚Äî‚Äî TI·ªÜN √çCH B·ªÄN B·ªà ***/
const $ = s => document.querySelector(s), $$ = s => document.querySelectorAll(s);
const LS_CFG = 'onepaste_cfg_v1';
const LS_FEED = 'onepaste_feed_v1';
const LS_STATS = 'onepaste_stats_v1';

function isVN(){
  const lang=(navigator.language||'').toLowerCase();
  const tz=Intl.DateTimeFormat().resolvedOptions().timeZone||'';
  return lang.startsWith('vi') || tz.includes('Bangkok') || tz.includes('Ho_Chi_Minh');
}
function region(){ return localStorage.getItem('ab_region') || (isVN()?'VN':'GLOBAL'); }
function setQR(text){ $('#qr').src = `https://api.qrserver.com/v1/create-qr-code/?size=340x340&data=${encodeURIComponent(text)}`; }
function copy(txt){ return navigator.clipboard.writeText(txt).then(()=>alert('ƒê√£ sao ch√©p.')).catch(()=>alert('Thi·∫øt b·ªã ch·∫∑n clipboard, vui l√≤ng gi·ªØ & ch·ªçn.')); }
function netBadge(ok){ const el=$('#statusNet'); if(!el) return; el.textContent = ok?'Online':'Offline'; el.className = 'badge ' + (ok?'ok':'err'); }
window.addEventListener('online', ()=>netBadge(true)); window.addEventListener('offline', ()=>netBadge(false)); netBadge(navigator.onLine);

function timeout(ms){ return new Promise((_,rej)=>setTimeout(()=>rej(new Error('TIMEOUT')),ms)); }
async function fetchJSON(url, ms=6000){ return Promise.race([fetch(url,{cache:'no-store'}).then(r=>r.ok?r.json():Promise.reject(new Error(r.status))), timeout(ms)]); }
async function trySources(urls, cacheKey, fallback){
  for(const u of urls){
    try{ const data = await fetchJSON(u); localStorage.setItem(cacheKey, JSON.stringify(data)); return {data, source:u}; }
    catch(e){ /* th·ª≠ ngu·ªìn k·∫ø */ }
  }
  try{ const c = localStorage.getItem(cacheKey); if(c){ return {data:JSON.parse(c), source:'cache'}; } }catch(e){}
  return {data:fallback, source:'default'};
}

/*** 4) ‚Äî‚Äî SANITIZE FEED (ch·∫∑n XSS) ***/
function sanitize(html){
  try{
    const tmp = document.createElement('div'); tmp.innerHTML = html || '';
    const ALLOWED_TAGS = new Set(['B','I','EM','STRONG','P','BR','UL','OL','LI','A','CODE','PRE','SPAN','SMALL']);
    const ALLOWED_ATTR = { 'A':['href','target','rel'], 'SPAN':['class'], 'DIV':['class'], 'CODE':['class'], 'PRE':['class'] };
    (function walk(node){
      [...node.children].forEach(ch=>{
        if(!ALLOWED_TAGS.has(ch.tagName)){ const repl=document.createTextNode(ch.textContent||''); ch.replaceWith(repl); return; }
        [...ch.attributes].forEach(a=>{
          const ok = (ALLOWED_ATTR[ch.tagName]||[]).includes(a.name.toLowerCase());
          if(!ok) ch.removeAttribute(a.name);
          if(ch.tagName==='A' && a.name.toLowerCase()==='href'){
            try{ const url = new URL(ch.getAttribute('href'), location.href); if(!/^https?:/i.test(url.protocol)) ch.removeAttribute('href'); }catch(_){ ch.removeAttribute('href'); }
            ch.setAttribute('rel','noopener noreferrer'); ch.setAttribute('target','_blank');
          }
        });
        walk(ch);
      });
    })(tmp);
    return tmp.innerHTML;
  }catch(_){ return ''; }
}

/*** 5) ‚Äî‚Äî LEARNING (Œµ-greedy + UCB) ***/
function stats(){ try{return JSON.parse(localStorage.getItem(LS_STATS)||'{}')}catch{return{}} }
function saveStats(s){ localStorage.setItem(LS_STATS, JSON.stringify(s)); }
function pickOffer(pool){
  const s = stats(); s.stats=s.stats||{}; s.total=s.total||0; const eps=0.12;
  if(Math.random()<eps) return pool[Math.floor(Math.random()*pool.length)];
  let best=pool[0],score=-1;
  for(const o of pool){
    const st=s.stats[o.id]||{}; const ctr=(st.c||0)/Math.max(1,(st.v||0));
    const ucb=ctr + Math.sqrt(2*Math.log(1+(s.total||1))/Math.max(1,(st.v||0)));
    if(ucb>score){score=ucb;best=o;}
  } return best;
}
function markView(id){ const s=stats(); s.stats=s.stats||{}; s.stats[id]=s.stats[id]||{v:0,c:0}; s.stats[id].v++; s.total=(s.total||0)+1; saveStats(s); }
function markClick(id){ const s=stats(); s.stats=s.stats||{}; s.stats[id]=s.stats[id]||{v:0,c:0}; s.stats[id].c++; saveStats(s); }

/*** 6) ‚Äî‚Äî UI: PAYMENTS, OFFERS, FEED ***/
function paintPayments(cfg){
  const pays = cfg.payments||{}; const list=$('#payList'); list.innerHTML=''; const rows=[];
  const map = {
    eth:   v => ({title:'ETH (ENS/Address)', id:v.id, qr:(v.scheme||'ethereum:')+(v.id||'')}),
    usdt:  v => ({title:'USDT (ERC‚Äë20)',     id:v.id, qr:v.id}),
    momo:  v => ({title:'MoMo',              id:v.id, qr:v.id}),
    bank:  v => { const [acc,name]=(v.id||'').split('|'); return {title:'Vietcombank', id:`${acc} ‚Ä¢ ${name||''}`, qr:`VCB:${acc}?memo=LightUnfold&name=${encodeURIComponent(name||'')}`}},
    paypal:v => ({title:'PayPal',            id:v.id, qr:`paypal.me/${encodeURIComponent((v.id||'').split('@')[0])}`})
  };
  Object.entries(map).forEach(([k,fn])=>{
    if(!pays[k]) return; const norm=fn(pays[k]);
    const row=document.createElement('div'); row.className='paybtn';
    row.innerHTML=`<div><b>${norm.title}</b><div class="muted mono">${norm.id}</div></div><button class="copy">Copy</button>`;
    row.onclick=()=>{ $('#payAddr').textContent=norm.id; setQR(norm.qr); $$('.paybtn').forEach(x=>x.classList.remove('active')); row.classList.add('active'); };
    row.querySelector('.copy').onclick=(e)=>{ e.stopPropagation(); copy(norm.id); };
    list.appendChild(row); rows.push(row);
  });
  if(rows[0]) rows[0].click();
  $('#btnCopy').onclick=()=>copy($('#payAddr').textContent||'');
}
function paintOffers(cfg){
  const regionNow=region(); $('#tagRegion').textContent='Region: '+regionNow;
  const OFFERS=[
    {id:'binance',title:'M·ªü Binance Mi·ªÖn Ph√≠',url:cfg.links?.binance,regions:['VN','GLOBAL']},
    {id:'algos',title:'M·ªü AlgosOne Mi·ªÖn Ph√≠',url:cfg.links?.algos,regions:['GLOBAL','CRYPTO','VN']}
  ].filter(o=>o.url);
  const pool=OFFERS.filter(o=>o.regions.includes(regionNow)); const pick=pickOffer(pool.length?pool:OFFERS);
  const box=$('#offerBox');
  box.innerHTML=`
    <a class="btn out" id="offer" href="${pick.url}" target="_blank" rel="noopener">üî• ${pick.title}</a>
    ${cfg.links?.binance?`<a class="btn out" href="${cfg.links.binance}" target="_blank" rel="noopener">üöÄ Binance</a>`:''}
    ${cfg.links?.algos?`<a class="btn out" href="${cfg.links.algos}" target="_blank" rel="noopener">üåê AlgosOne</a>`:''}`;
  $('#offer').addEventListener('click',()=>markClick(pick.id));
  markView(pick.id);
  if(cfg.links?.binance){ const el=$('#ctaB'); if(el) el.href=cfg.links.binance; }
  if(cfg.links?.algos){ const el=$('#ctaA'); if(el) el.href=cfg.links.algos; }
}
function renderFeed(feed, source){
  const box=$('#feedList'), info=$('#feedInfo'); if(!box) return;
  $('#statusFeed').textContent = 'Feed: ' + (source==='default'?'m·∫∑c ƒë·ªãnh': source==='cache'?'cache': 'remote');
  $('#statusFeed').className = 'badge ' + (source==='default'?'warn': 'ok');
  info.textContent = `C·∫≠p nh·∫≠t: ${new Date(feed.updated_at||Date.now()).toLocaleString()} ‚Ä¢ ngu·ªìn: ${source}`;
  box.innerHTML='';
  (feed.items||[]).forEach(it=>{
    const card=document.createElement('div'); card.className='card';
    const body = sanitize(it.body_html||'');
    const tags = (it.tags||[]).map(t=>`<span class="tag">#${t}</span>`).join(' ');
    card.innerHTML = `
      <b>${it.title||''}</b>
      <div class="muted" style="margin:6px 0">${tags}</div>
      <div>${body}</div>
      ${it.cta?.url?`<div class="row" style="margin-top:8px"><a class="btn out" href="${it.cta.url}" target="_blank" rel="noopener">${it.cta.label||'Xem'}</a></div>`:''}
    `;
    box.appendChild(card);
  });
}

/*** 7) ‚Äî‚Äî FEED & CONFIG LOADER ***/
async function loadConfig(){ const {data,source}=await trySources(CONFIG_URLS, LS_CFG, defaults); return {cfg:{...defaults,...data, payments:{...defaults.payments, ...(data.payments||{})}}, source}; }
async function loadFeed(){ const {data,source}=await trySources(FEED_URLS, LS_FEED, FEED_DEFAULT); return {feed:{updated_at:data.updated_at||new Date().toISOString(), items:Array.isArray(data.items)&&data.items.length?data.items:FEED_DEFAULT.items}, source}; }

/*** 8) ‚Äî‚Äî REGION & GATE & SHARE ***/
function bindRegionButtons(){ $$('button[data-region]').forEach(b=>b.onclick=()=>{ localStorage.setItem('ab_region', b.dataset.region); location.reload(); }); }
function bindGate(cfg){
  const SECRET=String(cfg.premium?.unlock_code||'');
  $('#doUnlock').onclick=()=>{ const ok=(String($('#unlockCode').value||'').trim()===SECRET);
    $('#uMsg').textContent = ok ? '‚úÖ ƒê√£ m·ªü kho√°' : '‚ùå Sai m√£';
    $('#opened').style.display = ok ? 'block' : 'none';
    if(ok) localStorage.setItem('premium_unlocked','1'); };
  $('#remember').onclick=()=> localStorage.setItem('remember_code',$('#unlockCode').value||'');
  if(localStorage.getItem('premium_unlocked')==='1') $('#opened').style.display='block';
}
(function share(){
  const base=location.origin+location.pathname; const peer=localStorage.getItem('peer_id')||Math.random().toString(36).slice(2);
  localStorage.setItem('peer_id',peer); const myRef=`${base}?ref=${peer}`;
  const t=encodeURIComponent(document.title), u=encodeURIComponent(myRef);
  const map={sh_tg:`https://t.me/share/url?url=${u}&text=${t}`,sh_x:`https://twitter.com/intent/tweet?text=${t}&url=${u}`,sh_fb:`https://www.facebook.com/sharer/sharer.php?u=${u}`,sh_in:`https://www.linkedin.com/sharing/share-offsite/?url=${u}`};
  for(const id in map){ const el=document.getElementById(id); if(el) el.href=map[id]; }
})();

/*** 9) ‚Äî‚Äî Lang & Heartbeat & 3D ***/
let LANG=(localStorage.getItem('lang')||(navigator.language||'vi')).toLowerCase().startsWith('vi')?'vi':'en';
function applyLang(){
  if(LANG==='vi'){ $('#tagline').textContent='Thanh to√°n ƒëa k√™nh ‚Ä¢ Affiliate t·ªëi ∆∞u CTR ‚Ä¢ Feed c∆° h·ªôi t·ª± c·∫≠p nh·∫≠t ‚Ä¢ B·ªÅn b·ªâ IPFS/IPNS'; $('#globeCap').textContent='Tr√°i ƒê·∫•t On‚ÄëChain ¬∑ 3D'; }
  else { $('#tagline').textContent='Multi-channel payments ‚Ä¢ CTR-optimized affiliate ‚Ä¢ Auto-updating opportunity feed ‚Ä¢ IPFS/IPNS resilience'; $('#globeCap').textContent='On‚ÄëChain Earth ¬∑ 3D'; }
}
applyLang();
$('#lang').onclick=()=>{ LANG=(LANG==='vi'?'en':'vi'); localStorage.setItem('lang',LANG); applyLang(); };
setInterval(()=>{ $('#hb').textContent=new Date().toLocaleTimeString(); },1000);

(function earth(){
  try{
    const canvas=document.getElementById('globe3d'); const prefersReduced = window.matchMedia('(prefers-reduced-motion: reduce)').matches;
    const renderer=new THREE.WebGLRenderer({canvas,antialias:true,alpha:true});
    const DPR=Math.min(window.devicePixelRatio||1,2); const W=canvas.clientWidth||300,H=canvas.clientHeight||300;
    renderer.setPixelRatio(DPR); renderer.setSize(W,H,false);
    const scene=new THREE.Scene(); const camera=new THREE.PerspectiveCamera(50,W/H,0.1,100); camera.position.z=6;
    scene.add(new THREE.AmbientLight(0x9fc9ff,0.55), new THREE.DirectionalLight(0xffffff,0.95));
    const loader=new THREE.TextureLoader();
    const earth=new THREE.Mesh(new THREE.SphereGeometry(2.4,64,64),
      new THREE.MeshPhongMaterial({map:loader.load('https://threejs.org/examples/textures/planets/earth_atmos_2048.jpg')}));
    scene.add(earth);
    function anim(){ if(!prefersReduced) earth.rotation.y+=0.0024; renderer.render(scene,camera); requestAnimationFrame(anim); }
    anim();
  }catch(e){ $('#globeCap').textContent='‚Äî'; }
})();

/*** 10) ‚Äî‚Äî BOOT ***/
document.getElementById('ens').textContent = defaults.ens;
(async function start(){
  try{
    const {cfg} = await loadConfig();
    paintPayments(cfg);
    paintOffers(cfg);
    bindRegionButtons();
    bindGate(cfg);

    const {feed, source} = await loadFeed();
    renderFeed(feed, source);
  }catch(e){ console.warn('Boot failed', e); $('#statusFeed').textContent='Feed: l·ªói'; $('#statusFeed').className='badge err'; }
})();
</script>

<!-- Service Worker (cache nh·∫π ‚Äì offline kh·∫£ d·ª•ng) -->
<script>
if('serviceWorker' in navigator){
  const sw = `
    const CACHE='onepaste-v1';
    self.addEventListener('install',e=>{e.waitUntil(caches.open(CACHE).then(c=>c.addAll(['./'])) )});
    self.addEventListener('fetch',e=>{
      e.respondWith(
        caches.match(e.request).then(r=>r||fetch(e.request).then(res=>{
          const copy=res.clone(); caches.open(CACHE).then(c=>c.put(e.request,copy)); return res;
        }).catch(()=>r))
      );
    });
  `;
  const blob = new Blob([sw],{type:'text/javascript'}); const url = URL.createObjectURL(blob);
  navigator.serviceWorker.register(url).catch(()=>{});
}
</script>
</body>
</html>
