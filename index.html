<!doctype html>
<html lang="vi">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>LightUnfold ‚Ä¢ Web3 AI X1000 ‚Äî Ultra Hub</title>
<meta name="description" content="Web3 AI t·ª± ƒë·ªông 24/7: c∆° h·ªôi n·ªïi b·∫≠t, thanh to√°n QR (kh√¥ng l·ªô email), n·ªôi dung premium v·ªõi m√£ m·ªü kh√≥a, b√†i gi·ªõi thi·ªáu BNB & AlgosOne, i18n, c·ª±c nh·∫π."/>
<meta property="og:title" content="LightUnfold ‚Ä¢ Web3 AI X1000 ‚Äî Ultra Hub"/>
<meta property="og:description" content="C∆° h·ªôi th·ªã tr∆∞·ªùng realtime, thanh to√°n ƒëa k√™nh, paywall, bundles, affiliate, Command Center. T·ª± ƒë·ªông 24/7."/>
<meta property="og:type" content="website"/>
<meta property="og:url" content="https://vuhuyphat.github.io/index_ultra_hub.html"/>
<meta name="theme-color" content="#0b0f13"/>
<style>
:root{
  --bg:#0b0f13;--card:#10161d;--line:#1c2836;--txt:#e9eef4;--mut:#9fb3c8;--brand:#7dc1ff;--accent:#ffb000;
  --ok:#2ecc71;--bad:#ff4d4f;--pill:#0e141b
}
*{box-sizing:border-box}
html,body{margin:0;background:var(--bg);color:var(--txt);font:15px/1.6 system-ui,-apple-system,Segoe UI,Roboto,Arial}
a{color:#8ecbff;text-decoration:none}
.wrap{max-width:1100px;margin:0 auto;padding:16px}
.row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
.pill{display:inline-flex;gap:6px;align-items:center;background:var(--pill);border:1px solid var(--line);border-radius:999px;padding:6px 10px;color:var(--mut)}
.card{background:var(--card);border:1px solid var(--line);border-radius:14px;padding:16px;margin-top:12px}
.grid{display:grid;gap:14px;grid-template-columns:repeat(auto-fit,minmax(260px,1fr))}
.btn{display:inline-flex;gap:8px;align-items:center;background:var(--accent);color:#1a1300;border:0;border-radius:10px;padding:10px 14px;font-weight:700;cursor:pointer}
.btn.ghost{background:transparent;color:var(--txt);border:1px solid var(--line)}
h1{margin:8px 0 6px;font-size:28px}
h3{margin:0 0 8px}
.muted{color:var(--mut)}
.badge{display:inline-flex;align-items:center;gap:6px;border:1px solid var(--line);border-radius:999px;padding:4px 10px}
.list .item{display:flex;gap:10px;align-items:flex-start;padding:10px 0;border-top:1px dashed var(--line)}
.score{min-width:54px;text-align:center;border:1px solid var(--line);border-radius:8px;padding:4px 6px;color:#ffdca8;background:#241a00}
.tag{display:inline-block;border:1px solid var(--line);border-radius:8px;padding:2px 8px;margin:2px 4px 0 0;color:#bcd;font-size:12px}
input,textarea{width:100%;background:#0d131a;border:1px solid var(--line);border-radius:10px;color:var(--txt);padding:10px}
.small{font-size:12px}
.hidden{display:none}
.footer{padding:28px 0;text-align:center;color:var(--mut)}
/* modal */
.modal{position:fixed;inset:0;display:none;align-items:flex-end;justify-content:center;background:rgba(0,0,0,.35);z-index:90}
.modal.open{display:flex}
.sheet{width:100%;max-width:1100px;background:var(--card);border:1px solid var(--line);border-radius:16px 16px 0 0;padding:14px;max-height:87vh;overflow:auto}
.sheet h4{margin:6px 0 10px}
pre.json{white-space:pre-wrap;word-break:break-word;background:#0c1218;border:1px solid var(--line);border-radius:10px;padding:10px}
/* payments */
.pay{display:flex;gap:14px}
.pay .qr{width:160px;height:160px;border-radius:12px;border:1px solid var(--line);background:#000}
.pay .meta{flex:1;min-width:0}
/* share/fab */
.share{position:fixed;right:12px;bottom:82px;display:flex;gap:8px;background:var(--pill);border:1px solid var(--line);border-radius:12px;padding:8px;z-index:50}
.share a{font-size:18px}
.fab{position:fixed;left:12px;bottom:82px;background:var(--pill);border:1px solid var(--line);border-radius:999px;padding:10px 12px;color:var(--mut);z-index:50;cursor:pointer}
.alertbar{background:#1a2300;border:1px solid #344600;color:#e5ff9a;border-radius:10px;padding:8px;margin-top:8px}
/* light theme */
.light{--bg:#f7fafc;--card:#ffffff;--line:#e2e8f0;--txt:#0b0f13;--mut:#4a5568;--brand:#2563eb;--pill:#f3f6fa}
</style>
</head>
<body>
<div class="wrap">
  <!-- top row -->
  <div class="row">
    <button class="pill" id="backBtn">‚¨Ö Back</button>
    <span class="pill">ENS: <b id="ens">‚Äî</b></span>
    <span class="pill">Heartbeat: <b id="hb">‚Äî</b></span>
    <a class="pill" id="viewData">data</a>
    <a class="pill" id="viewCfg">config</a>
    <button class="pill" id="lang">VI/EN</button>
    <button class="pill" id="theme">üåó Theme</button>
  </div>

  <h1 id="brand">LightUnfold ‚Ä¢ Web3 AI X1000</h1>
  <div id="tagline" class="muted">‚Äî</div>

  <!-- HERO intro -->
  <section class="card">
    <div class="row" style="justify-content:space-between">
      <div class="muted">20,000+ AI ‚Ä¢ 200+ qu·ªëc gia ‚Ä¢ 200+ ng√¥n ng·ªØ ‚Ä¢ T·ª± ƒë·ªông 24/7 ‚Ä¢ Chuy·ªÉn ƒë·ªïi X1000</div>
      <div class="badge small">C·∫≠p nh·∫≠t: <span id="updated">‚Äî</span></div>
    </div>
    <div id="marquee" class="small muted" style="margin-top:6px"></div>
    <div id="alertBox" class="alertbar hidden">‚ö†Ô∏è <b>Alert:</b> ƒêang c√≥ bi·∫øn ƒë·ªông l·ªõn. Ki·ªÉm tra c√°c c∆° h·ªôi b√™n d∆∞·ªõi.</div>
  </section>

  <!-- Opportunities -->
  <section class="card">
    <div class="row" style="justify-content:space-between">
      <h3>üî• C∆° h·ªôi n·ªïi b·∫≠t</h3>
      <div class="row">
        <span class="pill small" id="scanMode">qu√©t: ‚Äî</span>
        <button class="pill" id="btnRefresh">‚Üª L√†m m·ªõi</button>
      </div>
    </div>
    <div id="opps" class="list"></div>
  </section>

  <!-- Payments -->
  <section class="card">
    <div class="row" style="justify-content:space-between">
      <h3>üí≥ Thanh to√°n</h3>
      <button class="btn" id="openPay">M·ªü ph∆∞∆°ng th·ª©c</button>
    </div>
    <div class="muted small">Thanh to√°n qua QR / v√≠. Sau khi thanh to√°n b·∫°n s·∫Ω nh·∫≠n <b>m√£ m·ªü kh√≥a</b> ƒë·ªÉ truy c·∫≠p n·ªôi dung cao c·∫•p. H·ªó tr·ª£: <span id="supportLabel"></span></div>
  </section>

  <!-- Paywall -->
  <section class="card">
    <h3>üîì N·ªôi dung cao c·∫•p</h3>
    <div id="gateLock">
      <input id="unlockCode" placeholder="Nh·∫≠p m√£ m·ªü kh√≥a‚Ä¶">
      <input id="txHash" placeholder="(T√πy ch·ªçn) D√°n m√£ giao d·ªãch/b·∫±ng ch·ª©ng" style="margin-top:8px">
      <div class="row" style="margin-top:8px">
        <button class="btn" id="doUnlock">M·ªü kh√≥a</button>
        <button class="btn ghost" id="remember">Nh·ªõ tr√™n thi·∫øt b·ªã</button>
      </div>
      <div id="uMsg" class="muted" style="margin-top:6px"></div>
      <div class="muted small" style="margin-top:8px">C√°ch ho·∫°t ƒë·ªông: Thanh to√°n ‚ûú nh·∫≠n m√£ ‚ûú nh·∫≠p ƒë·ªÉ m·ªü kh√≥a; c√≥ th·ªÉ l∆∞u m√£ & TX hash tr√™n thi·∫øt b·ªã c·ªßa b·∫°n.</div>
    </div>
    <div id="gateOpen" class="hidden">
      <div class="row"><span class="pill" style="color:var(--ok)">‚úî ƒê√£ m·ªü kh√≥a</span><button class="btn ghost" id="relock">Kho√° l·∫°i</button></div>
      <div id="premium" class="grid" style="margin-top:10px"></div>
    </div>
  </section>

  <!-- Bundles -->
  <section class="card">
    <h3>üß∞ G√≥i s·∫£n ph·∫©m / B√°o c√°o</h3>
    <div id="bundles" class="grid"></div>
  </section>

  <!-- Affiliates + articles -->
  <section class="card">
    <h3>ü§ù Affiliate & B√†i gi·ªõi thi·ªáu</h3>
    <div id="affs" class="grid"></div>
    <div class="row" style="margin-top:8px">
      <button class="btn ghost" data-article="bnb">Gi·ªõi thi·ªáu BNB ‚Üó</button>
      <button class="btn ghost" data-article="algos">Gi·ªõi thi·ªáu AlgosOne ‚Üó</button>
    </div>
  </section>

  <!-- Command Center (links c√°c c√¥ng c·ª• c≈©) -->
  <section class="card">
    <h3>üß≠ Command Center</h3>
    <div class="grid" id="cmd"></div>
    <div class="muted small">Hub t·ª± ph√°t hi·ªán & li√™n k·∫øt t·ªõi c√°c c√¥ng c·ª• c≈© (dex.html, hyper_v2.html, pro.html, super_auto.html, super_share.html, xpeotl.html, xportal.html‚Ä¶).</div>
  </section>

  <div class="footer">¬© <span id="year"></span> LightUnfold ‚Ä¢ T·ª± ƒë·ªông 24/7</div>
</div>

<!-- Floating share + back-to-top -->
<div class="share" id="shareBar">
  <a target="_blank" title="Telegram" id="sh_tg">üì£</a>
  <a target="_blank" title="X/Twitter" id="sh_x">ùïè</a>
  <a target="_blank" title="Facebook" id="sh_fb">f</a>
  <a target="_blank" title="LinkedIn" id="sh_in">in</a>
</div>
<div class="fab" id="toTop">‚Üë Top</div>

<!-- Modal: Payments / JSON viewer / Articles -->
<div class="modal" id="modal">
  <div class="sheet">
    <div class="row" style="justify-content:space-between">
      <h4 id="modalTitle">Modal</h4>
      <button class="pill" id="closeModal">ƒê√≥ng</button>
    </div>
    <div id="modalBody"></div>
  </div>
</div>

<script>
/* ========== helpers ========== */
const $=s=>document.querySelector(s), $$=s=>document.querySelectorAll(s);
const fmt=n=>Number(n||0).toLocaleString(undefined,{maximumFractionDigits:8});
const ago=iso=>{if(!iso) return "‚Äî"; const s=(Date.now()-new Date(iso))/1000|0; if(s<60) return s+"s"; const m=s/60|0; if(m<60) return m+"m"; const h=m/60|0; if(h<24) return h+"h"; return (h/24|0)+"d";}
const qrlink=v=>`https://api.qrserver.com/v1/create-qr-code/?size=300x300&data=${encodeURIComponent(v)}`;
const getJSON = async (url,cacheKey)=>{ try{ const r=await fetch(url,{cache:"no-store"}); const j=await r.json(); if(cacheKey) localStorage.setItem(cacheKey,JSON.stringify(j)); return j; }catch(e){ if(cacheKey){ try{ return JSON.parse(localStorage.getItem(cacheKey)||"{}"); }catch{return {};} } return {}; } };
function setTheme(mode){ document.body.classList.toggle('light',mode==='light'); localStorage.setItem('theme',mode); }
function setLang(){ const L=(localStorage.getItem('lang')||navigator.language||'vi').slice(0,2); $('#lang').textContent=(L==='vi'?'VI/EN':'EN/VI'); }
function openModal(title,html){ $('#modalTitle').textContent=title; $('#modalBody').innerHTML=html; $('#modal').classList.add('open'); }
function closeModal(){ $('#modal').classList.remove('open'); $('#modalBody').innerHTML=''; }

/* ========== defaults (fallback khi thi·∫øu config.json) ========== */
const DEF={
  site:{
    brand:"LightUnfold ‚Ä¢ Web3 AI X1000",
    ens:"lightunfold.eth",
    tagline:"20,000+ AI ‚Ä¢ 200+ qu·ªëc gia ‚Ä¢ 200+ ng√¥n ng·ªØ ‚Ä¢ t·ª± ƒë·ªông 24/7 ‚Ä¢ chuy·ªÉn ƒë·ªïi X1000",
    contact:{ email:"", telegram:"", discord:"" },
    payments:{
      eth:"0x54E15A7b6d4213beE87800432A151d794638E3C2",
      usdt_erc20:"0x5da80d0f7e2df3cb0aa73d6a942bbe36b046b8f0",
      momo:"0567892030",
      vietcombank:"9567892030",
      paypal:""
    },
    affiliates:[
      {name:"Binance",url:"https://www.binance.com/vi/register?ref=GRO_20338_9V44N",tag:"Top CEX"},
      {name:"AlgosOne",url:"https://algosone.page.link/MbtR",tag:"AI Trading"},
      {name:"OKX",url:"https://www.okx.com/join/your-code",tag:"CEX"},
      {name:"Bybit",url:"https://www.bybit.com/invite?ref=your-code",tag:"Derivatives"}
    ]
  },
  feeds:{top_n:12},
  schedule:{refresh_minutes:10},
  secrets:{unlock_code:"X1000VIP"},
  store:{
    bundles:[
      {title:"Alpha Signals X",price:99,desc:"T√≠n hi·ªáu ng·∫Øn h·∫°n x√°c su·∫•t cao.",tags:["Scalping","DeFi","Spot"]},
      {title:"ETF & BTC Flow",price:79,desc:"D√≤ng v·ªën ETF/BTC ‚Äì qu·ªπ & miner.",tags:["BTC","ETF","Flow"]},
      {title:"Altseason Radar",price:69,desc:"Chu k·ª≥ v·ªën h√≥a & leader/laggard.",tags:["Cycle","Momentum"]},
      {title:"Whale Watcher Pro",price:89,desc:"Theo d√µi v√≠ c√° voi & giao d·ªãch l·ªõn.",tags:["Onchain","Whales"]},
      {title:"Airdrop Hunter",price:59,desc:"L·ªãch farming & ƒëi·ªÉm t√≠ch lu·ªπ.",tags:["Quest","Points"]},
      {title:"Perp Heatmap",price:79,desc:"Funding, OI, liquidation map.",tags:["Futures","Heatmap"]},
      {title:"Narrative Scanner",price:49,desc:"Xu h∆∞·ªõng L2, AI, RWA, GameFi.",tags:["Narrative"]},
      {title:"Risk Guard",price:39,desc:"C·∫£nh b√°o r·ªßi ro smart-money & dev activity.",tags:["Risk","Safety"]},
      {title:"Tokenomics Lens",price:69,desc:"L·ªãch vesting & pha lo√£ng.",tags:["Vesting","FDV"]},
      {title:"Copy-Trade Radar",price:59,desc:"Theo d√µi trader m·∫´u & t√≠n hi·ªáu sao ch√©p.",tags:["Copy","Social"]}
    ],
    premium:[
      {title:"Alpha Feed Pro",desc:"D√≤ng tin alpha si√™u nhanh (ƒë·ªô tr·ªÖ ms).",bullets:["B·∫•t th∆∞·ªùng d√≤ng ti·ªÅn","Ngu·ªìn ƒëa k√™nh","B·ªô l·ªçc nhi·ªÖu"],link:"data/latest.json"},
      {title:"Deal Flow Private",desc:"T·ªïng h·ª£p deal/seed m·ªü private.",bullets:["ƒêi·ªÅu ki·ªán","∆Øu ti√™n th·ªùi gian"]}
    ]
  }
};

/* ========== boot ========== */
(async function(){
  // theme/lang/back
  setTheme(localStorage.getItem('theme')||'dark'); $('#theme').onclick=()=>setTheme((localStorage.getItem('theme')||'dark')==='dark'?'light':'dark');
  setLang(); $('#lang').onclick=()=>{ const cur=(localStorage.getItem('lang')||navigator.language||'vi').slice(0,2); localStorage.setItem('lang',cur==='vi'?'en':'vi'); setLang(); };
  $('#backBtn').onclick=()=>history.length>1?history.back():window.scrollTo({top:0,behavior:'smooth'});
  $('#toTop').onclick=()=>window.scrollTo({top:0,behavior:'smooth'});
  $('#year').textContent=new Date().getFullYear();

  // config + data
  const cfg = Object.assign({}, DEF, await getJSON('config.json','cfg'));
  $('#brand').textContent = cfg.site?.brand || DEF.site.brand;
  $('#ens').textContent = cfg.site?.ens || '‚Äî';
  $('#tagline').textContent = cfg.site?.tagline || DEF.site.tagline;

  // support label (kh√¥ng l·ªô email tr·ª±c ti·∫øp)
  const contact = cfg.site?.contact||{};
  const contactLabel = contact.telegram ? `<a target="_blank" href="${contact.telegram}">Telegram</a>`
                     : contact.discord  ? `<a target="_blank" href="${contact.discord}">Discord</a>`
                     : contact.email    ? `<a href="mailto:${contact.email}">Email</a>` : '@lightunfold';
  $('#supportLabel').innerHTML = contactLabel;

  // JSON viewer buttons
  $('#viewCfg').onclick=async()=>{ const j = await getJSON('config.json'); openModal('config.json', `<div class="row"><a class="pill" target="_blank" href="config.json">M·ªü tab m·ªõi ‚Üó</a></div><pre class="json">${escapeHTML(JSON.stringify(j,null,2))}</pre>`); };
  $('#viewData').onclick=async()=>{ const j = await getJSON('data/latest.json'); openModal('data/latest.json', `<div class="row"><a class="pill" target="_blank" href="data/latest.json">M·ªü tab m·ªõi ‚Üó</a></div><pre class="json">${escapeHTML(JSON.stringify(j,null,2))}</pre>`); };

  // share links
  const url=location.href, title=document.title;
  $('#sh_tg').href = `https://t.me/share/url?url=${encodeURIComponent(url)}`;
  $('#sh_x').href  = `https://twitter.com/intent/tweet?text=${encodeURIComponent(title)}&url=${encodeURIComponent(url)}`;
  $('#sh_fb').href = `https://www.facebook.com/sharer/sharer.php?u=${encodeURIComponent(url)}`;
  $('#sh_in').href = `https://www.linkedin.com/sharing/share-offsite/?url=${encodeURIComponent(url)}`;

  // payments modal (kh√¥ng l·ªô email, m·ªü v√≠/QR/copy)
  $('#openPay').onclick=()=>openPayments(cfg);
  $('#closeModal').onclick=closeModal;
  $('#modal').addEventListener('click',e=>{ if(e.target.id==='modal') closeModal(); });

  // Bundles
  $('#bundles').innerHTML = (cfg.store?.bundles||[]).map(b=>`
    <div class="card">
      <div class="row" style="justify-content:space-between"><b>${b.title}</b><span class="badge">$${b.price}</span></div>
      <div class="muted">${b.desc||''}</div>
      <div style="margin-top:6px">${(b.tags||[]).map(t=>`<span class="tag">${t}</span>`).join('')}</div>
      <div class="row" style="margin-top:8px"><button class="btn" onclick="document.getElementById('unlockCode').focus()">Mua & nh·∫≠p m√£</button></div>
    </div>
  `).join('');

  // Affiliates
  $('#affs').innerHTML = (cfg.site?.affiliates||[]).map(a=>`
    <a class="card" target="_blank" href="${appendRef(a.url)}">
      <b>${a.name}</b><div class="muted small">${a.tag||'ƒê·ªëi t√°c'}</div>
    </a>`).join('');

  // Articles (BNB/AlgosOne) modal
  $$('button[data-article]').forEach(btn=>{
    btn.onclick=()=>{ const kind=btn.dataset.article;
      const html = kind==='bnb'
        ? `<div class="muted">BNB Chain: ph√≠ th·∫•p, TPS cao, h·ªá sinh th√°i DeFi/Game/NFT l·ªõn. Tip:
            <ul><li>Bridge BNB ‚ûú DEX (Pancake) ƒë·ªÉ farming APR</li><li>D√πng v√≠ EVM (MetaMask) m·∫°ng BSC</li><li>Theo d√µi narrative L2/Restaking tr√™n BSC</li></ul></div>`
        : `<div class="muted">AlgosOne: c√¥ng c·ª• AI theo d√µi thanh kho·∫£n & xu h∆∞·ªõng (li√™n k·∫øt ƒë·ªëi t√°c). G·ª£i √Ω s·ª≠ d·ª•ng:
            <ul><li>Thi·∫øt l·∫≠p watchlist theo cap/volume</li><li>B·∫≠t c·∫£nh b√°o bi·∫øn ƒë·ªông > X%</li><li>K·∫øt h·ª£p chi·∫øn l∆∞·ª£c spot + DCA</li></ul></div>
           <div style="margin-top:8px"><a class="pill" target="_blank" href="${appendRef('https://algosone.page.link/MbtR')}">M·ªü AlgosOne ‚Üó</a></div>`;
      openModal(kind==='bnb'?'Gi·ªõi thi·ªáu BNB':'Gi·ªõi thi·ªáu AlgosOne', html);
    };
  });

  // Command center (ph√°t hi·ªán t·ª± ƒë·ªông)
  const tools=["dex.html","hyper_v2.html","pro.html","super_auto.html","super_share.html","xpeotl.html","xportal.html"];
  const checkPromises = tools.map(p=>fetch(p,{method:'HEAD'}).then(r=>r.ok?p:null).catch(()=>null));
  const exist = (await Promise.all(checkPromises)).filter(Boolean);
  $('#cmd').innerHTML = exist.length ? exist.map(p=>`<a class="card" href="${p}" target="_blank"><b>${p.replace('.html','').toUpperCase()}</b></a>`).join('') : '<div class="muted">Ch∆∞a ph√°t hi·ªán c√¥ng c·ª• c≈©.</div>';

  // Paywall
  const SECRET=String(cfg.secrets?.unlock_code||'X1000VIP');
  const saved=localStorage.getItem('unlocked_code')||'';
  if(saved===SECRET) openGate(true);
  $('#doUnlock').onclick=()=>{ const code=$('#unlockCode').value.trim(); const tx=$('#txHash').value.trim();
    if(code===SECRET){ openGate(true); if(tx) localStorage.setItem('tx_hash',tx); $('#uMsg').innerHTML='<span style="color:var(--ok)">ƒê√£ m·ªü kh√≥a!</span>'; }
    else $('#uMsg').innerHTML='<span style="color:var(--bad)">M√£ kh√¥ng ƒë√∫ng.</span>';
  };
  $('#remember').onclick=()=>{ const c=$('#unlockCode').value.trim(); if(c){ localStorage.setItem('unlocked_code',c); $('#uMsg').textContent='ƒê√£ l∆∞u tr√™n thi·∫øt b·ªã.'; } };
  $('#relock').onclick=()=>{ localStorage.removeItem('unlocked_code'); openGate(false); };

  function openGate(open){
    $('#gateLock').classList.toggle('hidden',open);
    $('#gateOpen').classList.toggle('hidden',!open);
    if(open){
      const prem = (cfg.store?.premium||DEF.store.premium).map(p=>
        `<div class="card"><b>${p.title}</b><div class="muted">${p.desc||''}</div>
         <ul>${(p.bullets||[]).map(x=>`<li>${x}</li>`).join('')}</ul>
         ${p.link?`<a target="_blank" href="${p.link}" class="pill">Xem d·ªØ li·ªáu ‚Üó</a>`:''}</div>`).join('');
      $('#premium').innerHTML=prem;
      const tx=localStorage.getItem('tx_hash'); if(tx) $('#uMsg').innerHTML=`<span class="muted">TX ƒë√£ l∆∞u: ${tx}</span>`;
    }
  }

  // data load + alerts
  const EVERY = Math.max(3, Number(cfg.schedule?.refresh_minutes||10)) * 60 * 1000;
  let autoTimer=null;
  async function loadData(){
    let latest = await getJSON('data/latest.json','latest');
    if(Array.isArray(latest.items)){
      render(latest.items, latest.generated_at, 'data');
    }else{
      const items = await scanLive();
      render(items, new Date().toISOString(), 'fallback');
    }
  }
  $('#btnRefresh').onclick=()=>loadData();
  await loadData(); autoTimer=setInterval(loadData, EVERY);

  function render(items, ts, mode){
    $('#hb').textContent = mode==='fallback'?'LIVE':ago(ts);
    $('#scanMode').textContent = 'qu√©t: '+(mode==='fallback'?'fallback':'data');
    $('#updated').textContent = ago(ts);
    const topTick = (items||[]).slice(0,6).map(x=>`${x.symbol}: $${fmt(x.price)} (${(x.ch24h>=0?'+':'')}${(x.ch24h||0).toFixed(2)}%)`).join(' ‚Ä¢ ');
    $('#marquee').textContent = topTick || '‚Äî';

    // alert if any coin moves strongly
    const alerting = (items||[]).some(x => Math.abs(x.ch24h||0) >= 12 || (x.vol24h||0) > 1_000_000_000);
    $('#alertBox').classList.toggle('hidden', !alerting);

    $('#opps').innerHTML = (items||[]).map(x=>`
      <div class="item">
        <div class="score">${(x.score>=0?'+':'')}${(x.score||0).toFixed(2)}</div>
        <div style="flex:1;min-width:0">
          <div class="row" style="justify-content:space-between;gap:8px">
            <div><b>${x.symbol}</b> ¬∑ <span class="muted">${x.name||''}</span></div>
            <a target="_blank" href="${x.link}">Chi ti·∫øt ‚Üó</a>
          </div>
          <div class="row" style="gap:8px">
            <span class="tag">Gi√°: $${fmt(x.price)}</span>
            <span class="tag">24h: ${(x.ch24h>=0?'+':'')}${(x.ch24h||0).toFixed(2)}%</span>
            <span class="tag">Kh·ªëi l∆∞·ª£ng: $${fmt(x.vol24h||0)}</span>
            <span class="tag">Ngu·ªìn: ${x.source}</span>
          </div>
        </div>
      </div>`).join('') || '<div class="muted">Ch∆∞a c√≥ d·ªØ li·ªáu.</div>';
  }

  async function scanLive(){
    const out=[];
    try{
      const cg = await getJSON("https://api.coingecko.com/api/v3/coins/markets?vs_currency=usd&order=volume_desc&per_page=40&page=1&price_change_percentage=1h,24h,7d");
      if(Array.isArray(cg)){
        for(const c of cg){
          out.push({
            source:'coingecko',
            symbol:(c.symbol||'').toUpperCase(), name:c.name,
            price:+c.current_price||0, ch24h:+c.price_change_percentage_24h_in_currency||0, vol24h:+c.total_volume||0,
            score:(+c.price_change_percentage_1h_in_currency||0)*0.4 + (+c.price_change_percentage_24h_in_currency||0)*0.35 + (+c.price_change_percentage_7d_in_currency||0)*0.25 + Math.log10((+c.total_volume||1)),
            link:`https://www.coingecko.com/en/coins/${c.id}`
          });
        }
      }
    }catch{}
    try{
      const cl = await getJSON("https://api.coinlore.net/api/tickers/?start=0&limit=40");
      (cl?.data||[]).forEach(c=>{
        out.push({
          source:'coinlore',
          symbol:(c.symbol||'').toUpperCase(), name:c.name,
          price:+c.price_usd||0, ch24h:+c.percent_change_24h||0, vol24h:+c.volume24||0,
          score:(+c.percent_change_24h||0)*0.7 + Math.log10((+c.volume24||1)),
          link:`https://www.coinlore.com/coin/${(c.name||'').toLowerCase().replace(/\s+/g,'-')}`
        });
      });
    }catch{}
    const best={}; out.forEach(it=>{ if(!it.symbol) return; if(!best[it.symbol]||it.score>best[it.symbol].score) best[it.symbol]=it; });
    return Object.values(best).sort((a,b)=>b.score-a.score).slice(0,(cfg.feeds?.top_n||12));
  }

  function openPayments(cfg){
    const P = cfg.site?.payments||{};
    const lines=[];
    if(P.eth) lines.push(payBlock('ETH (EVM)', P.eth, 'N·∫°p ETH/USDT tr√™n EVM.', 'https://metamask.app.link/'));
    if(P.usdt_erc20) lines.push(payBlock('USDT (ERC20)', P.usdt_erc20, 'USDT m·∫°ng ERC20 Ethereum.'));
    if(P.momo) lines.push(payBlock('MoMo', P.momo, 'V√≠ MoMo Vi·ªát Nam.'));
    if(P.vietcombank) lines.push(payBlock('Vietcombank', P.vietcombank, 'Ng√¢n h√†ng VCB.'));
    if(P.paypal) lines.push(payBlock('PayPal', P.paypal, 'Thanh to√°n PayPal.', `https://www.paypal.me/${(P.paypal||'').split('@')[0]}`));

    openModal('Ph∆∞∆°ng th·ª©c thanh to√°n', lines.join('') || '<div class="muted">Ch∆∞a c·∫•u h√¨nh.</div>');
  }
  function payBlock(label,addr,hint,openUrl){
    const qr=qrlink(addr);
    return `<div class="card"><div class="pay">
      <img class="qr" alt="QR" src="${qr}">
      <div class="meta">
        <div class="row" style="justify-content:space-between"><b>${label}</b>${openUrl?`<a target="_blank" href="${openUrl}" class="pill">M·ªü v√≠ ‚Üó</a>`:''}</div>
        <div class="muted small" style="margin:6px 0">${hint||''}</div>
        <code class="small" style="word-break:break-all">${addr}</code>
        <div class="row" style="margin-top:8px">
          <button class="btn" onclick="navigator.clipboard.writeText('${addr}')">Sao ch√©p</button>
          <a class="btn" href="${qr}" download>‚ö° T·∫£i QR</a>
        </div>
      </div>
    </div></div>`;
  }

  function appendRef(u){
    try{
      const url = new URL(u);
      const ref = (new URL(location.href)).searchParams.get('ref');
      if(ref) url.searchParams.set('ref', ref);
      return url.toString();
    }catch{ return u; }
  }

  function escapeHTML(s){return String(s).replace(/[&<>"']/g,m=>({ "&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;" }[m]));}
})();
</script>
</body>
</html>
